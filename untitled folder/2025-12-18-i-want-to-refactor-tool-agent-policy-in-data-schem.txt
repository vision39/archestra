
 â–â–›â–ˆâ–ˆâ–ˆâ–œâ–Œ   Claude Code v2.0.17
â–â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›â–˜  Sonnet 4.5 Â· Claude API
  â–˜â–˜ â–â–    /Users/ildar/code/archestraai/archestra/platform

> I want to refactor tool-agent policy in data scheme. I think it needs to be configured per mcp server/tool, not per profile

maybe if profile needs a custom policy for a given tool, it could be done, but not creating by default

ultrathink

âº I'll help you refactor the tool-agent policy data schema. Let me first explore the current implementation to understand how policies are structured and then propose a new design.

âº Explore(Find policy database schemas)
  â¿ Â Done (27 tool uses Â· 43.2k tokens Â· 1m 12s)                                                                                                                                   

âº Explore(Analyze policy usage patterns)
  â¿ Â Done (36 tool uses Â· 96.4k tokens Â· 1m 49s)                                                                                                                                   

âº Read(/tmp/policies_impact_analysis.md)
  â¿ Â Read 570 lines

âº Now let me design the new schema based on the analysis:

  Proposed Schema Refactoring

  Based on my analysis, here's my proposed design for moving policies from profile-tool level to MCP server/tool level:

  Design Principles

  1. Tool-level defaults: Policies should be configured at the tool level by default
  2. MCP server-specific policies: Optional policies that apply to specific MCP server instances
  3. Profile overrides: Profiles can still override with custom policies when needed
  4. Clear precedence: Profile override > Server-specific > Tool default
  5. Organization scoping: All policies scoped to organization for multi-tenancy

  New Database Schema

  -- Updated tool_invocation_policies table
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Scoping fields (precedence: agent_tool_id > tool_id+mcp_server_id > tool_id)
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,  -- Optional server-specific
    agent_tool_id UUID REFERENCES agent_tools(id) ON DELETE CASCADE,  -- Optional profile override

    -- Policy configuration (unchanged)
    argument_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- Constraints
    CONSTRAINT tool_invocation_policy_scope_check
      CHECK (
        -- Either profile-override OR default/server-specific (but not both)
        (agent_tool_id IS NOT NULL AND mcp_server_id IS NULL) OR
        (agent_tool_id IS NULL)
      ),

    -- Unique constraint to prevent duplicate policies
    CONSTRAINT tool_invocation_policy_unique
      UNIQUE NULLS NOT DISTINCT (
        organization_id, tool_id, mcp_server_id, agent_tool_id,
        argument_name, operator, value, action
      )
  );

  -- Updated trusted_data_policies table (same pattern)
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Scoping fields (same as tool_invocation_policies)
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    agent_tool_id UUID REFERENCES agent_tools(id) ON DELETE CASCADE,

    -- Policy configuration (unchanged)
    description TEXT NOT NULL,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- Constraints (same pattern)
    CONSTRAINT trusted_data_policy_scope_check
      CHECK (
        (agent_tool_id IS NOT NULL AND mcp_server_id IS NULL) OR
        (agent_tool_id IS NULL)
      ),

    CONSTRAINT trusted_data_policy_unique
      UNIQUE NULLS NOT DISTINCT (
        organization_id, tool_id, mcp_server_id, agent_tool_id,
        attribute_path, operator, value, action
      )
  );

  -- Indexes for performance
  CREATE INDEX idx_tool_invocation_policies_tool
    ON tool_invocation_policies(organization_id, tool_id);

  CREATE INDEX idx_tool_invocation_policies_server
    ON tool_invocation_policies(organization_id, tool_id, mcp_server_id);

  CREATE INDEX idx_tool_invocation_policies_agent_tool
    ON tool_invocation_policies(agent_tool_id);

  CREATE INDEX idx_trusted_data_policies_tool
    ON trusted_data_policies(organization_id, tool_id);

  CREATE INDEX idx_trusted_data_policies_server
    ON trusted_data_policies(organization_id, tool_id, mcp_server_id);

  CREATE INDEX idx_trusted_data_policies_agent_tool
    ON trusted_data_policies(agent_tool_id);

  Policy Evaluation Precedence

  When evaluating policies for a tool call:

  1. Check for profile override (agent_tool_id is set)
    - If found, use only these policies
    - Ignore tool-level and server-level policies
  2. Check for MCP server-specific (tool_id + mcp_server_id set, agent_tool_id null)
    - If found, use these policies
    - Fall through to tool defaults if no match
  3. Check for tool default (tool_id set, both mcp_server_id and agent_tool_id null)
    - These are the baseline policies for the tool

  API Changes

  New query parameters for policy endpoints:
  GET /api/autonomy-policies/tool-invocation
    ?toolId=<uuid>              // Filter by tool
    &mcpServerId=<uuid>         // Filter by MCP server
    &agentToolId=<uuid>         // Filter by profile override
    &scope=default|server|override  // Filter by scope type

  POST /api/autonomy-policies/tool-invocation
    Body: {
      toolId: string,           // Required
      mcpServerId?: string,     // Optional (server-specific)
      agentToolId?: string,     // Optional (profile override)
      argumentName: string,
      operator: string,
      value: string,
      action: string,
      reason?: string
    }

  Migration Strategy

  Phase 1: Schema Migration
  1. Add new columns to existing tables (tool_id, mcp_server_id, organization_id)
  2. Make agent_tool_id nullable
  3. Backfill tool_id and organization_id from agent_tools relationships
  4. Add constraints and indexes

  Phase 2: Code Updates
  1. Update models to support new scoping
  2. Update evaluation logic with precedence rules
  3. Update API routes to accept new parameters
  4. Update frontend to manage tool-level policies

  Phase 3: Data Migration
  1. Identify duplicate policies across profiles
  2. Deduplicate common policies as tool defaults
  3. Keep divergent policies as profile overrides
  4. Remove auto-configuration timestamps from agent_tools for migrated policies

  Phase 4: Deprecation
  1. Mark old profile-tool-only approach as legacy
  2. Update UI to encourage tool-level policy creation
  3. Provide migration tool for users to consolidate policies

  Benefits

  âœ… Reduced redundancy: Common policies defined once per tool
  âœ… Easier management: Update tool policies in one place
  âœ… Server-specific configuration: Support MCP server variations
  âœ… Backward compatible: Profile overrides still work
  âœ… Gradual migration: Can coexist with old approach
  âœ… Clear precedence: Easy to understand evaluation order

  Trade-offs

  âš ï¸ More complex queries: Need to check multiple scoping levels
  âš ï¸ Migration effort: Significant refactoring required
  âš ï¸ Auto-configuration: May need rethinking for tool-level policies

  Would you like me to proceed with implementing this refactoring? I can start with the database schema migration and work through the layers systematically.

> draw diagram before/after 

âº Let me create clear before/after diagrams to visualize the schema changes:

  BEFORE: Current Profile-Tool Scoped Policies

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                         CURRENT ARCHITECTURE                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Organizations (1) â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ (N) Agents/Profiles
                          â”‚
                          â””â”€â”€â”€â”€â”€â”€ (N) MCP Servers


  Tools (N) â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€ (N) MCP Servers
                    â”‚     (belongs to, optional)
                    â”‚
                    â””â”€â”€â”€â”€ Profiles via agent_tools junction


  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           agent_tools                                     â”‚
  â”‚  (junction table - the CURRENT policy scope)                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  - id (PK)                                                                â”‚
  â”‚  - agent_id (FK â†’ agents)                                                 â”‚
  â”‚  - tool_id (FK â†’ tools)                                                   â”‚
  â”‚  - allow_usage_when_untrusted_data_is_present                            â”‚
  â”‚  - tool_result_treatment                                                  â”‚
  â”‚  - policies_auto_configured_at                                            â”‚
  â”‚  - policies_auto_configured_reasoning                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                    â”‚
           â”‚                                    â”‚
           â–¼                                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies    â”‚    â”‚ trusted_data_policies       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ - id                        â”‚    â”‚ - id                        â”‚
  â”‚ - agent_tool_id (FK) â—„â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€ agent_tool_id (FK)        â”‚
  â”‚ - argument_name             â”‚    â”‚ - description               â”‚
  â”‚ - operator                  â”‚    â”‚ - attribute_path            â”‚
  â”‚ - value                     â”‚    â”‚ - operator                  â”‚
  â”‚ - action                    â”‚    â”‚ - value                     â”‚
  â”‚ - reason                    â”‚    â”‚ - action                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  PROBLEM: Every profile needs separate policy configuration per tool!

  Example scenario:
    Profile A + Tool "search_web" â†’ 5 policies
    Profile B + Tool "search_web" â†’ 5 policies (duplicated!)
    Profile C + Tool "search_web" â†’ 5 policies (duplicated!)

    Result: 15 policies for what should be 5 tool-level defaults

  AFTER: Proposed Tool/Server Scoped Policies

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                          PROPOSED ARCHITECTURE                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Organizations (1) â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ (N) Agents/Profiles
                          â”‚
                          â”œâ”€â”€â”€â”€â”€â”€ (N) MCP Servers
                          â”‚
                          â””â”€â”€â”€â”€â”€â”€ (N) Policies (new: org-scoped)


  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                      tool_invocation_policies                             â”‚
  â”‚  (NEW: tool-scoped with optional refinements)                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  - id (PK)                                                                â”‚
  â”‚  - organization_id (FK â†’ organizations) â—„â”€â”€â”€ NEW: Multi-tenant scoping  â”‚
  â”‚                                                                           â”‚
  â”‚  SCOPING HIERARCHY (nullable fields for flexibility):                    â”‚
  â”‚  - tool_id (FK â†’ tools) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ REQUIRED: Base level        â”‚
  â”‚  - mcp_server_id (FK â†’ mcp_servers) â—„â”€â”€â”€â”€â”€â”€ OPTIONAL: Server-specific   â”‚
  â”‚  - agent_tool_id (FK â†’ agent_tools) â—„â”€â”€â”€â”€â”€â”€ OPTIONAL: Profile override  â”‚
  â”‚                                                                           â”‚
  â”‚  - argument_name, operator, value, action, reason (unchanged)            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â””â”€â”€â”€ Same pattern for trusted_data_policies


  POLICY EVALUATION PRECEDENCE:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Lookup Order (first match wins):                                       â”‚
  â”‚                                                                          â”‚
  â”‚  1. Profile Override    (agent_tool_id IS NOT NULL)                     â”‚
  â”‚     â””â”€ "This specific profile needs different rules"                    â”‚
  â”‚                                                                          â”‚
  â”‚  2. Server-Specific     (tool_id + mcp_server_id, agent_tool_id NULL)   â”‚
  â”‚     â””â”€ "This tool behaves differently on this MCP server"               â”‚
  â”‚                                                                          â”‚
  â”‚  3. Tool Default        (tool_id only, other fields NULL)               â”‚
  â”‚     â””â”€ "Default policy for all uses of this tool"                       â”‚
  â”‚                                                                          â”‚
  â”‚  4. No Policy           (fallback to agent_tools config)                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  EXAMPLE DATA:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies                                                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ org_id â”‚ tool_id      â”‚ srv_idâ”‚ agent_tool_idâ”‚ arg_name    â”‚ action     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ org-1  â”‚ search_web   â”‚ NULL  â”‚ NULL         â”‚ query       â”‚ block      â”‚ â—„â”€ DEFAULT
  â”‚ org-1  â”‚ search_web   â”‚ srv-A â”‚ NULL         â”‚ query       â”‚ allow      â”‚ â—„â”€ SERVER-SPECIFIC
  â”‚ org-1  â”‚ search_web   â”‚ NULL  â”‚ agt-tool-99  â”‚ query       â”‚ sanitize   â”‚ â—„â”€ PROFILE OVERRIDE
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Query: "What policy applies to Profile X using search_web on Server A?"

  Evaluation logic:
    1. Check agent_tool_id = agt-tool-99 â†’ Found! Use "sanitize" âœ“
    2. (Skip checking server/default since override found)

  Query: "What policy applies to Profile Y using search_web on Server A?"
    (Profile Y has no override)

  Evaluation logic:
    1. Check agent_tool_id for Profile Y â†’ Not found
    2. Check tool_id + mcp_server_id (search_web + srv-A) â†’ Found! Use "allow" âœ“
    3. (Skip default since server-specific found)

  Query: "What policy applies to Profile Z using search_web on Server B?"
    (Profile Z has no override, Server B has no specific policy)

  Evaluation logic:
    1. Check agent_tool_id for Profile Z â†’ Not found
    2. Check tool_id + mcp_server_id (search_web + srv-B) â†’ Not found
    3. Check tool_id only (search_web) â†’ Found! Use "block" (DEFAULT) âœ“

  Visual Comparison: Policy Duplication

  BEFORE (profile-scoped):
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Tool: "search_web"

  Profile A: policy-001, policy-002, policy-003  â—„â”
  Profile B: policy-004, policy-005, policy-006  â—„â”œâ”€ Same rules, 
  Profile C: policy-007, policy-008, policy-009  â—„â”¤  duplicated 3x!
  Profile D: policy-010, policy-011, policy-012  â—„â”˜

  Total: 12 policy records


  AFTER (tool-scoped with overrides):
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Tool: "search_web"

  DEFAULT:    policy-001, policy-002, policy-003  â—„â”€â”€â”€ Shared by A, B, C, D
  Server X:   policy-004 (refinement)             â—„â”€â”€â”€ Only for profiles using Server X
  Profile D:  policy-005, policy-006 (override)   â—„â”€â”€â”€ D needs custom config

  Total: 6 policy records (50% reduction!)

  Migration Path Diagram

  MIGRATION STRATEGY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Phase 1: Schema Evolution
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies (BEFORE)       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ - agent_tool_id (FK, NOT NULL)          â”‚
  â”‚ - argument_name                          â”‚
  â”‚ - operator, value, action                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ ADD COLUMNS
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies (AFTER)        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ - organization_id (FK, NOT NULL) â—„â”€â”€ NEWâ”‚
  â”‚ - tool_id (FK, NOT NULL) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NEWâ”‚
  â”‚ - mcp_server_id (FK, NULL) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ NEWâ”‚
  â”‚ - agent_tool_id (FK, NULL) â—„â”€â”€ NULLABLE â”‚
  â”‚ - argument_name                          â”‚
  â”‚ - operator, value, action                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  Phase 2: Data Deduplication
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Step 1: Analyze existing policies
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SELECT tool_id, argument_name, operator, value,  â”‚
    â”‚        action, COUNT(*) as duplication_count     â”‚
    â”‚ FROM tool_invocation_policies p                  â”‚
    â”‚ JOIN agent_tools at ON p.agent_tool_id = at.id  â”‚
    â”‚ GROUP BY tool_id, argument_name, operator,       â”‚
    â”‚          value, action                           â”‚
    â”‚ HAVING COUNT(*) > 1                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    Result: List of duplicate policies across profiles

  Step 2: Create tool defaults for common policies
    For each duplicate policy group:
      - Create ONE tool-level policy (agent_tool_id = NULL)
      - Keep divergent policies as profile overrides

  Step 3: Clean up
    - Delete redundant profile-level policies
    - Keep only unique profile overrides


  Phase 3: Evaluation Logic Update
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  BEFORE (single query):
    SELECT * FROM tool_invocation_policies p
    JOIN agent_tools at ON p.agent_tool_id = at.id
    WHERE at.agent_id = ? AND at.tool_id IN (?)

  AFTER (precedence query with CTE):
    WITH policy_candidates AS (
      -- Profile overrides
      SELECT *, 1 as priority
      FROM tool_invocation_policies
      WHERE agent_tool_id = ?

      UNION ALL

      -- Server-specific
      SELECT *, 2 as priority
      FROM tool_invocation_policies
      WHERE tool_id = ? AND mcp_server_id = ?
        AND agent_tool_id IS NULL

      UNION ALL

      -- Tool defaults
      SELECT *, 3 as priority
      FROM tool_invocation_policies
      WHERE tool_id = ?
        AND mcp_server_id IS NULL
        AND agent_tool_id IS NULL
    )
    SELECT DISTINCT ON (argument_name, operator) *
    FROM policy_candidates
    ORDER BY argument_name, operator, priority

  Key Insights from Diagrams

  Current Issues:
  1. ğŸ”´ NÃ—M duplication: Every profile Ã— tool combination creates duplicate policies
  2. ğŸ”´ Management overhead: Updating a tool's policy requires touching N profiles
  3. ğŸ”´ Inconsistency risk: Easy for profiles to have slightly different versions

  Proposed Benefits:
  1. âœ… Single source of truth: Tool defaults apply to all profiles
  2. âœ… Refinement capability: Server-specific and profile overrides when needed
  3. âœ… Clear precedence: Override > Server > Default hierarchy
  4. âœ… Reduced storage: Deduplicate common policies
  5. âœ… Organization scoping: Multi-tenant ready

  Would you like me to proceed with implementing this refactoring?

> how would it look like in the UI? 

âº Read(frontend/src/app/tools/_parts/tool-call-policies.tsx)
  â¿ Â Read 209 lines

âº Read(frontend/src/app/tools/_parts/tool-result-policies.tsx)
  â¿ Â Read 342 lines

âº Search(pattern: "**/tools/page.tsx", path: "frontend/src/app")
  â¿ Â Found 1 file (ctrl+o to expand)

âº Read(frontend/src/app/tools/page.tsx)
  â¿ Â Read 84 lines

âº Now let me create detailed UI mockups showing the before/after:

  UI Mockups: Before vs After

  CURRENT UI (Profile-Tool Scoped)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tools Management                                          [+ Add Tool]   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  Profile: Sales Assistant â–¼        Tool: search_web                     â”‚
  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Can tool be used when untrusted data is present?               â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ DEFAULT  Allow usage when untrusted data present  [ON] â–   â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [query â–¼] [contains â–¼] [hack]                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: security]                  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [domain â–¼] [endsWith â–¼] [.internal]               [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Allow when untrusted â–¼]  [Reason: internal only]     â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy For Tool Parameters]               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Result Policies                                           â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Tool results impact agent decisions...                         â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ DEFAULT  [Mark as untrusted â–¼]                            â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [url] [contains â–¼] [company.com]                  [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Mark as trusted â–¼]                                    â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Tool Result Policy]                       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  Problem: If you have 10 profiles, you configure this 10 times! ğŸ˜«      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  PROPOSED UI (Tool/Server Scoped with Overrides)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Policy Management                                                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  [Tools] [MCP Servers] [Profile Overrides]  â—„â”€â”€â”€ NEW: Tab navigation   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  TAB 1: TOOLS VIEW (Default policies for all tools)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tool Policies                                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ” Search: [_______________]  Filter by: [All tools â–¼]                 â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ search_web                                       [Edit] [Ã—]  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ ğŸ“ Scope: DEFAULT (applies to all profiles)                    â”‚    â”‚
  â”‚  â”‚ ğŸ“¦ Source: Built-in                                             â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Call Policies (2)                                          â”‚    â”‚
  â”‚  â”‚  â€¢ If query contains "hack" â†’ Block always                      â”‚    â”‚
  â”‚  â”‚  â€¢ If domain endsWith ".internal" â†’ Allow when untrusted        â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Result Policies (1)                                        â”‚    â”‚
  â”‚  â”‚  â€¢ If url contains "company.com" â†’ Mark as trusted              â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ ğŸ”„ Applied to: 12 profiles                                      â”‚    â”‚
  â”‚  â”‚ ğŸ”€ Overrides: 2 profiles have custom policies                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ send_email                                       [Edit] [Ã—]  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ ğŸ“ Scope: DEFAULT                                               â”‚    â”‚
  â”‚  â”‚ ğŸ“¦ Source: Zapier MCP Server                                    â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Call Policies (1)                                          â”‚    â”‚
  â”‚  â”‚  â€¢ If to contains "external.com" â†’ Block always                 â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ ğŸ”„ Applied to: 5 profiles                                       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  [+ Add Tool Policy]                                                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  TAB 2: MCP SERVERS VIEW (Server-specific refinements)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ MCP Server Policies                                                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Server-specific policies override tool defaults for specific servers   â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ–¥ï¸  Production Search MCP                          [Edit] [Ã—]  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Server ID: prod-search-01                                       â”‚    â”‚
  â”‚  â”‚ Type: Remote (https://search.company.com)                       â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool-specific policies for this server:                         â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ”§ search_web (2 policies)                               â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ“ Scope: SERVER-SPECIFIC                                 â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚                                                           â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If index contains "production" â†’ Mark as trusted        â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If cache_enabled equals "false" â†’ Block always          â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚                                                           â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ â„¹ï¸  These policies override the tool defaults when using  â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚    this specific MCP server                              â”‚   â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ ğŸ”„ Applied to: 8 profiles using this server                     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  [+ Add Server Policy]                                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  TAB 3: PROFILE OVERRIDES VIEW (Profile-specific exceptions)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Profile Policy Overrides                                                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Profile-specific policies take precedence over server and tool defaultsâ”‚
  â”‚                                                                          â”‚
  â”‚  ğŸ” Filter: [All profiles â–¼]  Show: [Only profiles with overrides â˜‘]   â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ‘¤ Sales Assistant                                  [Edit] [Ã—]  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Custom policies for this profile:                               â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ”§ search_web â†’ OVERRIDE (replaces default)             â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ“ Scope: PROFILE-SPECIFIC                               â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚                                                           â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If query contains "competitor" â†’ Allow when untrusted   â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If customer_id startsWith "ENT" â†’ Mark as trusted      â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚                                                           â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚ âš ï¸  These policies REPLACE the tool & server defaults     â”‚   â”‚    â”‚
  â”‚  â”‚ â”‚    for this profile                                       â”‚   â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ [+ Add Override for Another Tool]                               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ‘¤ Customer Support Bot                             [Edit] [Ã—]  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Custom policies: None                                           â”‚    â”‚
  â”‚  â”‚ Using tool & server defaults âœ“                                  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ [+ Add Override]                                                â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  EXPANDED EDIT VIEW (when clicking Edit on search_web in Tools tab)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â† Back to Tool Policies                                                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Edit Tool Policy: search_web                                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ“ Scope: DEFAULT (applies to all profiles unless overridden)          â”‚
  â”‚  ğŸ“¦ Source: Built-in tool                                               â”‚
  â”‚  ğŸ”„ Currently applied to: 12 profiles                                   â”‚
  â”‚  ğŸ”€ Profiles with overrides: Sales Assistant, Executive Dashboard       â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Can tool be used when untrusted data is present?               â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ DEFAULT  Allow usage when untrusted data present  [ON] â–   â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [query â–¼] [contains â–¼] [hack]                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: security]                  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [domain â–¼] [endsWith â–¼] [.internal]               [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Allow when untrusted â–¼]  [Reason: internal only]     â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy For Tool Parameters]               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Result Policies                                           â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ DEFAULT  [Mark as untrusted â–¼]                            â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [url] [contains â–¼] [company.com]                  [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Mark as trusted â–¼]                                    â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Tool Result Policy]                       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Impact Preview                                                  â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ âœ“ 10 profiles will inherit these policies                      â”‚    â”‚
  â”‚  â”‚ âš ï¸  2 profiles have custom overrides and won't be affected:     â”‚    â”‚
  â”‚  â”‚    â€¢ Sales Assistant                                            â”‚    â”‚
  â”‚  â”‚    â€¢ Executive Dashboard                                        â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  [Cancel]                                    [Save Changes]             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Key UI Improvements

  1. Three-Tab Organization

  - Tools Tab: Manage default policies for each tool (most common use case)
  - MCP Servers Tab: Add server-specific refinements
  - Profile Overrides Tab: Handle exceptional cases per profile

  2. Visual Scope Indicators

  ğŸ“ Scope: DEFAULT          - Applies to all profiles
  ğŸ“ Scope: SERVER-SPECIFIC  - Only for this MCP server
  ğŸ“ Scope: PROFILE-SPECIFIC - Override for specific profile

  3. Impact Visibility

  ğŸ”„ Applied to: 12 profiles
  ğŸ”€ Overrides: 2 profiles have custom policies
  Shows administrators exactly which profiles are affected

  4. Inline Edit vs Expanded Edit

  - Collapsed view: Shows summary of policies (Tools tab)
  - Expanded edit: Full policy editor (similar to current UI)

  5. Search & Filtering

  ğŸ” Search tools by name
  Filter by: [All tools â–¼] [Only with policies â–¼]
  Show: [Only profiles with overrides â˜‘]

  6. Navigation Flow

  Before (current):
  Tools page â†’ Select Profile â†’ Select Tool â†’ Configure policies

  After (proposed):
  Policies page â†’ Tools tab â†’ Select Tool â†’ Configure default policies
                 â†’ MCP Servers tab â†’ Select Server â†’ Add refinements
                 â†’ Profile Overrides â†’ Select Profile â†’ Add exceptions

  7. Benefits Summary Display

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ’¡ Policy Efficiency                                        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Tool defaults: 15 policies                                  â”‚
  â”‚ Server refinements: 8 policies                              â”‚
  â”‚ Profile overrides: 3 policies                               â”‚
  â”‚                                                             â”‚
  â”‚ Total: 26 policies                                          â”‚
  â”‚ vs. Old approach would need: 180 policies (85% reduction!) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  8. Warning When Creating Override

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ âš ï¸  Create Profile Override?                                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ You're about to create a profile-specific override for:     â”‚
  â”‚                                                              â”‚
  â”‚ Profile: Sales Assistant                                     â”‚
  â”‚ Tool: search_web                                             â”‚
  â”‚                                                              â”‚
  â”‚ This will replace the default policies for this profile.    â”‚
  â”‚                                                              â”‚
  â”‚ Current default has 2 policies:                              â”‚
  â”‚  â€¢ Block queries containing "hack"                           â”‚
  â”‚  â€¢ Allow internal domains                                    â”‚
  â”‚                                                              â”‚
  â”‚ Consider: Can you achieve this with a server-specific       â”‚
  â”‚ policy instead?                                              â”‚
  â”‚                                                              â”‚
  â”‚ [Cancel]  [Create Server Policy]  [Create Override Anyway]  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  This UI design reduces duplication while maintaining flexibility for exceptional cases. Would you like me to proceed with implementing this refactoring?

> in a nutshell this is ABAC policy 

âº Exactly! You're absolutely right. This is a classic Attribute-Based Access Control (ABAC) policy system, and recognizing that opens up much better design patterns.

  Current Reality: It's Already ABAC

  Your policies are evaluating attributes to make decisions:

  // Tool Invocation Policy
  If [query] (attribute) [contains] (operator) ["hack"] (value)
    â†’ Block always (action)

  // Trusted Data Policy  
  If [emails[*].from] (attribute path) [endsWith] (operator) ["@company.com"] (value)
    â†’ Mark as trusted (action)

  The Real Problem

  Your current implementation couples ABAC policies to profile-tool relationships, which creates:

  1. âŒ Policy duplication (same policy Ã— N profiles)
  2. âŒ No policy reusability across profiles
  3. âŒ Inconsistent policy enforcement (each profile can diverge)

  Better ABAC Design: Separate Policies from Assignments

  ABAC Standard Pattern:
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Policy Catalog   â”‚  â† Define policies once
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ assigned to
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Resources        â”‚  â† Tools, MCP Servers
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ used by
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Subjects         â”‚  â† Profiles/Agents
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Proposed Schema (True ABAC)

  -- 1. Policy Definitions (reusable policies)
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL,
    name TEXT NOT NULL,  -- e.g., "Block Malicious Queries"
    description TEXT,

    -- Policy rule (ABAC attributes)
    argument_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    UNIQUE(organization_id, name)
  );

  -- 2. Policy Assignments (attach policies to resources)
  CREATE TABLE tool_policy_assignments (
    id UUID PRIMARY KEY,
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies(id),
    organization_id UUID NOT NULL,

    -- Assignment scope (hierarchy)
    tool_id UUID NOT NULL REFERENCES tools(id),
    mcp_server_id UUID REFERENCES mcp_servers(id),  -- Optional: server-specific

    -- Priority for conflict resolution
    priority INTEGER DEFAULT 100,

    created_at TIMESTAMP,

    UNIQUE NULLS NOT DISTINCT (policy_id, tool_id, mcp_server_id)
  );

  -- 3. Profile Exceptions (override for specific profiles)
  CREATE TABLE profile_policy_exceptions (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL,
    agent_id UUID NOT NULL REFERENCES agents(id),
    tool_id UUID NOT NULL REFERENCES tools(id),

    -- Exception type
    action TEXT NOT NULL,  -- "disable_policy" | "replace_with_custom"

    -- If replace_with_custom, specify custom policy inline
    custom_policy_id UUID REFERENCES tool_invocation_policies(id),

    created_at TIMESTAMP,

    UNIQUE(agent_id, tool_id)
  );

  Benefits of True ABAC Design

  âœ… Policy Reusability
     â””â”€ Define "Block SQL Injection" once
     â””â”€ Assign to 50 different tools
     â””â”€ All profiles inherit automatically

  âœ… Centralized Management
     â””â”€ Update policy definition in one place
     â””â”€ All assignments reflect change immediately

  âœ… Policy Versioning (future)
     â””â”€ Track policy changes over time
     â””â”€ Rollback to previous versions

  âœ… Policy Sets (future)
     â””â”€ Group related policies
     â””â”€ Assign entire sets to tools/servers
     â””â”€ E.g., "Production Security Baseline"

  âœ… Audit Trail (future)
     â””â”€ Who created/modified policies
     â””â”€ When assignments changed
     â””â”€ Policy evaluation logs

  Example Usage

  // Define reusable policies
  const blockMaliciousPolicy = {
    name: "Block Malicious Input",
    argumentName: "query",
    operator: "contains",
    value: "hack|inject|exploit",
    action: "block_always"
  };

  const trustInternalPolicy = {
    name: "Trust Internal Domains",
    argumentName: "domain",
    operator: "endsWith",
    value: ".company.com",
    action: "mark_as_trusted"
  };

  // Assign to resources
  assign(blockMaliciousPolicy, { toolId: "search_web" });
  assign(blockMaliciousPolicy, { toolId: "database_query" });
  assign(blockMaliciousPolicy, { toolId: "file_search" });

  assign(trustInternalPolicy, {
    toolId: "search_web",
    mcpServerId: "prod-search-server"
  });

  // Result: 3 policies, 4 assignments
  // vs. Old way: 4 Ã— N profiles = potentially 40+ duplicate policies!

  UI with Policy Catalog

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Policy Management                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  [Policy Catalog] [Assignments] [Profile Exceptions]        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  TAB 1: POLICY CATALOG (Define policies)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Policy Library                               [+ New Policy] â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                              â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ â”‚ ğŸ“‹ Block Malicious Input                    [Edit]   â”‚   â”‚
  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚ â”‚ If argument [query] [contains] [hack|inject]         â”‚   â”‚
  â”‚ â”‚ Then [Block always]                                   â”‚   â”‚
  â”‚ â”‚                                                       â”‚   â”‚
  â”‚ â”‚ ğŸ”— Assigned to: 12 tools, 3 servers                   â”‚   â”‚
  â”‚ â”‚ ğŸ‘¥ Affects: 45 profiles                               â”‚   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                              â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ â”‚ ğŸ“‹ Trust Internal Domains                   [Edit]   â”‚   â”‚
  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚ â”‚ If result [domain] [endsWith] [.company.com]         â”‚   â”‚
  â”‚ â”‚ Then [Mark as trusted]                                â”‚   â”‚
  â”‚ â”‚                                                       â”‚   â”‚
  â”‚ â”‚ ğŸ”— Assigned to: 5 tools                               â”‚   â”‚
  â”‚ â”‚ ğŸ‘¥ Affects: 30 profiles                               â”‚   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  TAB 2: ASSIGNMENTS (Attach policies to resources)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Policy Assignments                         [+ New Assignment]â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Group by: [Tool â–¼]                                          â”‚
  â”‚                                                              â”‚
  â”‚ ğŸ”§ search_web                                                â”‚
  â”‚   â€¢ Block Malicious Input (priority: 100)                   â”‚
  â”‚   â€¢ Trust Internal Domains (priority: 50)                   â”‚
  â”‚   â€¢ Rate Limit Check (priority: 75)                         â”‚
  â”‚                                                              â”‚
  â”‚ ğŸ”§ database_query                                            â”‚
  â”‚   â€¢ Block SQL Injection (priority: 100)                     â”‚
  â”‚   â€¢ Audit All Queries (priority: 1)                         â”‚
  â”‚                                                              â”‚
  â”‚ ğŸ–¥ï¸  Production MCP Server â†’ search_web                      â”‚
  â”‚   â€¢ Trust Internal Domains (overrides tool default)         â”‚
  â”‚   â€¢ Enable Cache Policy (priority: 80)                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Should You Adopt Full ABAC?

  Yes, if you want:
  - âœ… Policy reusability across tools
  - âœ… Centralized policy management
  - âœ… "Define once, use many" approach
  - âœ… Policy versioning in the future
  - âœ… Better audit capabilities

  Your proposed design is simpler:
  - Policies still defined per tool/server
  - Just eliminates profile-level duplication
  - Less abstraction = easier to understand initially

  My recommendation:
  Start with your proposed design (tool/server-scoped with profile overrides) since it:
  1. Solves the immediate duplication problem
  2. Requires less refactoring
  3. Can evolve to full ABAC later if needed

  But rename concepts to align with ABAC:
  - "Tool default policy" â†’ Policy attached to tool resource
  - "Server-specific policy" â†’ Policy attached to server+tool resource
  - "Profile override" â†’ Profile-level policy exception

  This sets you up for future evolution toward a full policy catalog if you need it. Want me to proceed with the implementation?

> we also have a credential in this equation, which could be team/personal 

âº Excellent point! Credentials add another dimension to the ABAC policy system. Let me explore the current credential implementation and redesign the policy system to account for
  it.

âº Explore(Find credential implementation)
  â¿ Â Done (29 tool uses Â· 79.8k tokens Â· 1m 14s)                                                                                                                                   

âº Perfect! Now I can see the full picture. Credentials are a crucial ABAC attribute that affects policy evaluation. Let me redesign the policy system to properly account for
  credential scoping.

  Updated ABAC Policy Design with Credentials

  The Complete Picture

  ABAC Policy Context Attributes:
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  1. Subject (Profile/Agent):
     - agentId
     - agent.teams[]
     - agent.considerContextUntrusted

  2. Resource (Tool):
     - toolId
     - tool.name
     - tool.parameters

  3. Environment (MCP Server):
     - mcpServerId (where tool is hosted)
     - server.type (local/remote)

  4. Credential (NEW - critical attribute):
     - credentialScope: "personal" | "team" | "organization"
     - credentialOwnerId (for personal)
     - credentialTeamId (for team)
     - isStaticCredential vs useDynamicTeamCredential

  Problem: Policies Should Vary by Credential Scope

  Example scenarios where credential matters:

  // Scenario 1: Personal credentials should be MORE restrictive
  // User's personal GitHub token - block writes to protect their account
  If credential.scope = "personal" AND tool = "github_create_issue"
    â†’ Block always (reason: protect personal account)

  // Scenario 2: Team credentials can be MORE permissive  
  If credential.scope = "team" AND tool = "github_create_issue"
    AND credential.teamId = "engineering-team"
    â†’ Allow (reason: shared team account, controlled access)

  // Scenario 3: Trusted data policies depend on credential ownership
  If credential.scope = "personal" AND result.owner != credential.ownerId
    â†’ Mark as untrusted (reason: accessing data outside personal scope)

  If credential.scope = "team" AND result.teamId = credential.teamId
    â†’ Mark as trusted (reason: team-owned data)

  Updated Schema Design

  -- Enhanced policy table with credential awareness
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Policy scoping hierarchy (same as before)
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    agent_tool_id UUID REFERENCES agent_tools(id) ON DELETE CASCADE,

    -- NEW: Credential scoping (optional - applies to specific credential types)
    credential_scope TEXT CHECK (credential_scope IN ('personal', 'team', 'organization')),
    credential_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,  -- For team-specific policies

    -- Policy rule (unchanged)
    argument_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- Constraints
    CONSTRAINT policy_scope_check CHECK (
      -- Profile override XOR default/server-specific (same as before)
      (agent_tool_id IS NOT NULL AND mcp_server_id IS NULL) OR
      (agent_tool_id IS NULL)
    ),

    CONSTRAINT credential_team_consistency CHECK (
      -- If credential_team_id is set, credential_scope must be 'team'
      (credential_team_id IS NULL) OR
      (credential_scope = 'team' AND credential_team_id IS NOT NULL)
    ),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, mcp_server_id, agent_tool_id,
      credential_scope, credential_team_id,
      argument_name, operator, value, action
    )
  );

  -- Same pattern for trusted_data_policies
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    agent_tool_id UUID REFERENCES agent_tools(id) ON DELETE CASCADE,

    -- NEW: Credential scoping
    credential_scope TEXT CHECK (credential_scope IN ('personal', 'team', 'organization')),
    credential_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,

    description TEXT NOT NULL,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    CONSTRAINT policy_scope_check CHECK (
      (agent_tool_id IS NOT NULL AND mcp_server_id IS NULL) OR
      (agent_tool_id IS NULL)
    ),

    CONSTRAINT credential_team_consistency CHECK (
      (credential_team_id IS NULL) OR
      (credential_scope = 'team' AND credential_team_id IS NOT NULL)
    ),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, mcp_server_id, agent_tool_id,
      credential_scope, credential_team_id,
      attribute_path, operator, value, action
    )
  );

  -- Indexes for credential-aware queries
  CREATE INDEX idx_tool_invocation_policies_credential_scope
    ON tool_invocation_policies(organization_id, tool_id, credential_scope);

  CREATE INDEX idx_tool_invocation_policies_credential_team
    ON tool_invocation_policies(organization_id, tool_id, credential_scope, credential_team_id)
    WHERE credential_scope = 'team';

  Policy Evaluation Precedence (Updated)

  /**
   * Policy evaluation with credential awareness
   * 
   * Precedence (highest to lowest):
   * 1. Profile override + Credential scope match
   * 2. Profile override (any credential)
   * 3. Server-specific + Credential team match
   * 4. Server-specific + Credential scope match  
   * 5. Server-specific (any credential)
   * 6. Tool default + Credential team match
   * 7. Tool default + Credential scope match
   * 8. Tool default (any credential)
   */

  async function evaluatePolicies(context: {
    agentId: string;
    agentToolId: string;
    toolId: string;
    mcpServerId?: string;
    credentialScope: 'personal' | 'team' | 'organization';
    credentialTeamId?: string;
    credentialOwnerId?: string;
    toolCalls: ToolCall[];
  }): Promise<PolicyResult> {

    // Query with precedence
    const policies = await db
      .select()
      .from(toolInvocationPoliciesTable)
      .where(
        and(
          eq(toolInvocationPoliciesTable.organizationId, context.orgId),
          eq(toolInvocationPoliciesTable.toolId, context.toolId),

          // Scoping predicates
          or(
            // 1. Profile override
            eq(toolInvocationPoliciesTable.agentToolId, context.agentToolId),

            // 2. Server-specific
            and(
              eq(toolInvocationPoliciesTable.mcpServerId, context.mcpServerId),
              isNull(toolInvocationPoliciesTable.agentToolId)
            ),

            // 3. Tool default
            and(
              isNull(toolInvocationPoliciesTable.mcpServerId),
              isNull(toolInvocationPoliciesTable.agentToolId)
            )
          ),

          // Credential filters
          or(
            // Exact credential match (highest priority)
            and(
              eq(toolInvocationPoliciesTable.credentialScope, context.credentialScope),
              context.credentialScope === 'team'
                ? eq(toolInvocationPoliciesTable.credentialTeamId, context.credentialTeamId)
                : isNull(toolInvocationPoliciesTable.credentialTeamId)
            ),

            // Credential scope match (no team specified)
            and(
              eq(toolInvocationPoliciesTable.credentialScope, context.credentialScope),
              isNull(toolInvocationPoliciesTable.credentialTeamId)
            ),

            // Any credential (fallback)
            isNull(toolInvocationPoliciesTable.credentialScope)
          )
        )
      )
      .orderBy(
        // Order by precedence
        desc(
          case()
            .when(isNotNull(toolInvocationPoliciesTable.agentToolId), 1000)
            .when(isNotNull(toolInvocationPoliciesTable.mcpServerId), 500)
            .else(100)
        ),
        desc(
          case()
            .when(isNotNull(toolInvocationPoliciesTable.credentialTeamId), 50)
            .when(isNotNull(toolInvocationPoliciesTable.credentialScope), 25)
            .else(0)
        )
      );

    // Evaluate policies against tool calls
    return evaluatePolicyRules(policies, context.toolCalls);
  }

  UI Design with Credential Awareness

  TAB 1: TOOLS VIEW (with credential policies)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tool Policies                                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ github_create_issue                          [Edit] [Ã—]     â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ ğŸ“ Scope: DEFAULT (all profiles, any credential)               â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Default Policies (3)                                            â”‚    â”‚
  â”‚  â”‚  â€¢ If repo contains "production" â†’ Block always                 â”‚    â”‚
  â”‚  â”‚  â€¢ If title contains "urgent" â†’ Allow when untrusted            â”‚    â”‚
  â”‚  â”‚  â€¢ If assignee empty â†’ Block always                             â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ” Personal Credential Policies (2)                       â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ“ Scope: When using PERSONAL credentials                  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If repo not owned by credential_owner â†’ Block always    â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If visibility equals "public" â†’ Block always            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â„¹ï¸  These policies ADD to defaults for personal tokens    â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ‘¥ Team Credential Policies: Engineering (1)              â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ ğŸ“ Scope: When using TEAM credentials (Engineering)       â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â€¢ If repo startsWith "eng-team" â†’ Mark as trusted         â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â„¹ï¸  Engineering team has more permissive policies         â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ [+ Add Default Policy]                                          â”‚    â”‚
  â”‚  â”‚ [+ Add Credential-Specific Policy]                              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  EXPANDED EDIT VIEW (with credential policies)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edit Tool Policy: github_create_issue                                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚ Policy Scope: [Default (any credential) â–¼]                              â”‚
  â”‚               â”œâ”€ Default (any credential)                               â”‚
  â”‚               â”œâ”€ Personal credentials only                              â”‚
  â”‚               â”œâ”€ Team credentials only                                  â”‚
  â”‚               â”‚   â””â”€ [Select team: Engineering â–¼]                       â”‚
  â”‚               â””â”€ Organization credentials only                          â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ ğŸ” Credential Scope: PERSONAL                                   â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [repo â–¼] [not owned by credential] [N/A]          [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: protect personal account]  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ â„¹ï¸  Special operators for credential context:                  â”‚    â”‚
  â”‚  â”‚     â€¢ "owned by credential" - checks ownership match           â”‚    â”‚
  â”‚  â”‚     â€¢ "in credential team" - checks team membership            â”‚    â”‚
  â”‚  â”‚     â€¢ "credential has permission" - checks credential scopes   â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy For Tool Parameters]               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  New Policy Operators for Credential Context

  // Add credential-aware operators
  type CredentialAwareOperator =
    | "owned_by_credential"      // Check if resource owner matches credential owner
    | "in_credential_team"       // Check if resource team matches credential team
    | "credential_has_scope"     // Check if credential has specific permission scope
    | "credential_is_type"       // Check credential type (personal/team/org)

  // Example usage
  {
    argumentName: "repo_owner",
    operator: "owned_by_credential",
    value: "",  // No value needed - checks against runtime credential
    action: "allow_when_context_is_untrusted"
  }

  {
    argumentName: "team_id",
    operator: "in_credential_team",
    value: "",  // Checks if team_id matches credential's team
    action: "mark_as_trusted"
  }

  Migration Impact

  Backward compatibility:
  - All existing policies have credential_scope = NULL (apply to any credential)
  - No behavior change for existing deployments
  - New credential-specific policies are opt-in

  New capabilities:
  1. âœ… Restrict personal credentials more strictly
  2. âœ… Allow team credentials more permissions
  3. âœ… Create team-specific policies for shared tools
  4. âœ… Prevent users from accessing data outside their credential scope

  Would you like me to proceed with implementing this credential-aware ABAC policy system?

> well, I just want to have one policy per tool.

the rest could be part of atrribute tools result/call policy (add if team=blah and ...) 

âº Ah, you're absolutely right! Much simpler and cleaner. Let me redesign this:

  Simplified Design: One Policy Per Tool + Attribute-Based Conditions

  Core Principle

  - One policy definition per tool (not duplicated across profiles/teams/credentials)
  - All context as attributes in conditions: team, credential scope, MCP server, profile, etc.
  - Policies evaluate attributes at runtime

  Simplified Schema

  -- Tool invocation policies (ONE per tool, organization-scoped)
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    -- Policy rule
    argument_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    -- Condition filters (ALL optional - policy applies when ALL match)
    condition_mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    condition_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,
    condition_credential_scope TEXT CHECK (condition_credential_scope IN ('personal', 'team', 'organization')),
    condition_profile_id UUID REFERENCES agents(id) ON DELETE CASCADE,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, argument_name, operator, value, action,
      condition_mcp_server_id, condition_team_id, condition_credential_scope, condition_profile_id
    )
  );

  -- Same pattern for trusted data policies
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    description TEXT NOT NULL,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    -- Condition filters (same as tool invocation)
    condition_mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    condition_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,
    condition_credential_scope TEXT CHECK (condition_credential_scope IN ('personal', 'team', 'organization')),
    condition_profile_id UUID REFERENCES agents(id) ON DELETE CASCADE,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, attribute_path, operator, value, action,
      condition_mcp_server_id, condition_team_id, condition_credential_scope, condition_profile_id
    )
  );

  -- Indexes
  CREATE INDEX idx_tool_invocation_policies_tool
    ON tool_invocation_policies(organization_id, tool_id);

  CREATE INDEX idx_trusted_data_policies_tool
    ON trusted_data_policies(organization_id, tool_id);

  Policy Examples

  -- Example 1: Default policy (applies to everyone)
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'search_web',
    argument_name: 'query',
    operator: 'contains',
    value: 'hack',
    action: 'block_always',
    -- All condition_* fields NULL = applies to all contexts
  );

  -- Example 2: Team-specific policy
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'search_web',
    argument_name: 'index',
    operator: 'equal',
    value: 'production',
    action: 'allow_when_context_is_untrusted',
    condition_team_id: 'engineering-team',  -- Only for this team
    -- Other conditions NULL = any server, any credential, any profile
  );

  -- Example 3: Personal credential restriction
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'github_create_issue',
    argument_name: 'visibility',
    operator: 'equal',
    value: 'public',
    action: 'block_always',
    condition_credential_scope: 'personal',  -- Only when using personal credentials
  );

  -- Example 4: Specific MCP server policy
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'database_query',
    argument_name: 'database',
    operator: 'equal',
    value: 'production',
    action: 'block_always',
    condition_mcp_server_id: 'dev-database-server',  -- Block prod queries on dev server
  );

  -- Example 5: Profile override (specific profile needs different rule)
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'search_web',
    argument_name: 'query',
    operator: 'contains',
    value: 'competitor',
    action: 'allow_when_context_is_untrusted',
    condition_profile_id: 'sales-assistant-profile',  -- Only for this profile
  );

  -- Example 6: Multi-condition policy (team + credential scope)
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'send_email',
    argument_name: 'to',
    operator: 'endsWith',
    value: '@external.com',
    action: 'block_always',
    condition_team_id: 'support-team',
    condition_credential_scope: 'personal',  -- Block external emails for support team using personal creds
  );

  Policy Evaluation Logic

  async function evaluatePolicies(context: {
    organizationId: string;
    toolId: string;
    profileId: string;
    teamId?: string;
    mcpServerId?: string;
    credentialScope: 'personal' | 'team' | 'organization';
    toolCalls: ToolCall[];
  }): Promise<PolicyResult> {

    // Fetch ALL policies for this tool
    const allPolicies = await db
      .select()
      .from(toolInvocationPoliciesTable)
      .where(
        and(
          eq(toolInvocationPoliciesTable.organizationId, context.organizationId),
          eq(toolInvocationPoliciesTable.toolId, context.toolId)
        )
      );

    // Filter policies that match current context
    const applicablePolicies = allPolicies.filter(policy => {
      // Check each condition - if set, must match
      if (policy.condition_profile_id && policy.condition_profile_id !== context.profileId) {
        return false;
      }
      if (policy.condition_team_id && policy.condition_team_id !== context.teamId) {
        return false;
      }
      if (policy.condition_mcp_server_id && policy.condition_mcp_server_id !== context.mcpServerId) {
        return false;
      }
      if (policy.condition_credential_scope && policy.condition_credential_scope !== context.credentialScope) {
        return false;
      }

      // All conditions matched (or were NULL)
      return true;
    });

    // Evaluate tool calls against applicable policies
    for (const toolCall of context.toolCalls) {
      for (const policy of applicablePolicies) {
        const argumentValue = toolCall.arguments[policy.argument_name];

        if (evaluateCondition(argumentValue, policy.operator, policy.value)) {
          if (policy.action === 'block_always') {
            return {
              isAllowed: false,
              reason: policy.reason,
              toolCallName: toolCall.name
            };
          }
          // Handle other actions...
        }
      }
    }

    return { isAllowed: true };
  }

  UI Design (Much Simpler!)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tool Policies                                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ” Search: [_______________]  Filter by: [All tools â–¼]                 â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ search_web                                       [Edit]     â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Tool Call Policies (4)                                          â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 1. If query contains "hack" â†’ Block always                      â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: All profiles, all teams, all credentials     â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 2. If index equals "production" â†’ Allow when untrusted          â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: Team: Engineering only                        â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 3. If domain endsWith ".internal" â†’ Allow when untrusted        â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: MCP Server: prod-search-01 only              â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 4. If query contains "competitor" â†’ Allow when untrusted        â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: Profile: Sales Assistant only                â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Result Policies (2)                                        â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 1. If url contains "company.com" â†’ Mark as trusted              â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: All profiles, all teams, all credentials     â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ 2. If owner equals credential_owner â†’ Mark as trusted           â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: Credential scope: personal only              â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  EXPANDED EDIT VIEW
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edit Tool Policies: search_web                                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #1                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [query â–¼] [contains â–¼] [hack]                         â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: security]                  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Apply this policy when: [+ Add Condition]                 â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   (no conditions = applies to everyone)                   â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #2                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [index â–¼] [equals â–¼] [production]                     â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Allow when untrusted â–¼]                              â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Apply this policy when:                                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   ğŸ·ï¸  Team: [Engineering â–¼]                      [Ã—]      â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   [+ Add Condition]                                        â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #3                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [query â–¼] [contains â–¼] [competitor]                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Allow when untrusted â–¼]                              â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Apply this policy when:                                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   ğŸ‘¤ Profile: [Sales Assistant â–¼]              [Ã—]        â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   ğŸ” Credential: [Team credentials only â–¼]     [Ã—]        â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   [+ Add Condition]                                        â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy For Tool Parameters]               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  [Save Changes]                                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  CONDITION DROPDOWN
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Add Condition                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ğŸ‘¤ Specific Profile                    â”‚
  â”‚ ğŸ·ï¸  Specific Team                       â”‚
  â”‚ ğŸ–¥ï¸  Specific MCP Server                â”‚
  â”‚ ğŸ” Credential Scope                    â”‚
  â”‚    â”œâ”€ Personal only                    â”‚
  â”‚    â”œâ”€ Team only                        â”‚
  â”‚    â””â”€ Organization only                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Migration from Current Schema

  -- Migrate existing profile-tool policies to tool-level with profile condition
  INSERT INTO tool_invocation_policies (
    organization_id,
    tool_id,
    argument_name,
    operator,
    value,
    action,
    reason,
    condition_profile_id  -- NEW: set to the profile from agent_tools
  )
  SELECT
    at.organization_id,
    at.tool_id,
    tip.argument_name,
    tip.operator,
    tip.value,
    tip.action,
    tip.reason,
    at.agent_id as condition_profile_id
  FROM tool_invocation_policies tip
  JOIN agent_tools at ON tip.agent_tool_id = at.id;

  -- After migration, analyze for consolidation:
  -- Find policies that are identical across all profiles â†’ remove condition_profile_id
  -- Find policies identical within teams â†’ convert to condition_team_id

  Key Benefits

  âœ… One policy per tool - no duplication
  âœ… Conditions are attributes - team, credential, server, profile are just filters
  âœ… Gradual specificity - start with general policies, add conditions as needed
  âœ… Simple mental model - "When does this policy apply?"
  âœ… Easy to consolidate - remove conditions to make policy broader
  âœ… No complex precedence - all matching policies apply

  This is much cleaner! Should I implement this design?

> I also want to add external agent id attribute 

âº Explore(Find external agent ID usage)
  â¿ Â Done (33 tool uses Â· 57.0k tokens Â· 1m 18s)                                                                                                                                   

âº Perfect! Now I understand. External agent IDs are client-provided identifiers for correlation/tracking, not for authorization. Let me add this as a condition attribute to the
  simplified policy design.

  Updated Schema with External Agent ID Condition

  -- Tool invocation policies (ONE per tool, organization-scoped)
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    -- Policy rule
    argument_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    -- Condition filters (ALL optional - policy applies when ALL match)
    condition_mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    condition_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,
    condition_credential_scope TEXT CHECK (condition_credential_scope IN ('personal', 'team', 'organization')),
    condition_profile_id UUID REFERENCES agents(id) ON DELETE CASCADE,
    condition_external_agent_id VARCHAR,  -- NEW: Client-provided agent identifier

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, argument_name, operator, value, action,
      condition_mcp_server_id, condition_team_id, condition_credential_scope,
      condition_profile_id, condition_external_agent_id
    )
  );

  -- Same for trusted data policies
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    description TEXT NOT NULL,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    -- Condition filters (same as tool invocation)
    condition_mcp_server_id UUID REFERENCES mcp_servers(id) ON DELETE CASCADE,
    condition_team_id TEXT REFERENCES team(id) ON DELETE CASCADE,
    condition_credential_scope TEXT CHECK (condition_credential_scope IN ('personal', 'team', 'organization')),
    condition_profile_id UUID REFERENCES agents(id) ON DELETE CASCADE,
    condition_external_agent_id VARCHAR,  -- NEW: Client-provided agent identifier

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, attribute_path, operator, value, action,
      condition_mcp_server_id, condition_team_id, condition_credential_scope,
      condition_profile_id, condition_external_agent_id
    )
  );

  -- Index for external agent ID filtering
  CREATE INDEX idx_tool_invocation_policies_external_agent
    ON tool_invocation_policies(organization_id, tool_id, condition_external_agent_id)
    WHERE condition_external_agent_id IS NOT NULL;

  CREATE INDEX idx_trusted_data_policies_external_agent
    ON trusted_data_policies(organization_id, tool_id, condition_external_agent_id)
    WHERE condition_external_agent_id IS NOT NULL;

  Policy Examples with External Agent ID

  -- Example 1: Restrict specific external agent from production access
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'database_query',
    argument_name: 'database',
    operator: 'equal',
    value: 'production',
    action: 'block_always',
    condition_external_agent_id: 'dev-bot-v1',  -- Block this specific external agent
    reason: 'Dev bot should not access production'
  );

  -- Example 2: Allow specific external agent special permissions
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'admin_command',
    argument_name: 'command',
    operator: 'startsWith',
    value: 'delete',
    action: 'allow_when_context_is_untrusted',
    condition_external_agent_id: 'trusted-automation-agent',  -- Only this external agent
    reason: 'Trusted automation can run delete commands'
  );

  -- Example 3: Team + External Agent combination
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'send_email',
    argument_name: 'to',
    operator: 'endsWith',
    value: '@customer.com',
    action: 'block_always',
    condition_team_id: 'support-team',
    condition_external_agent_id: 'support-bot-tier1',  -- Block tier1 bot from external emails
    reason: 'Tier 1 support bot cannot email customers directly'
  );

  -- Example 4: Different policies for production vs staging external agents
  INSERT INTO trusted_data_policies VALUES (
    tool_id: 'fetch_customer_data',
    attribute_path: 'customers[*].ssn',
    operator: 'exists',
    value: 'true',
    action: 'mark_as_trusted',
    condition_external_agent_id: 'prod-agent',  -- Production agent can see SSN
  );

  INSERT INTO trusted_data_policies VALUES (
    tool_id: 'fetch_customer_data',
    attribute_path: 'customers[*].ssn',
    operator: 'exists',
    value: 'true',
    action: 'sanitize_with_dual_llm',
    condition_external_agent_id: 'staging-agent',  -- Staging must sanitize SSN
  );

  Policy Evaluation with External Agent ID

  async function evaluatePolicies(context: {
    organizationId: string;
    toolId: string;
    profileId: string;
    teamId?: string;
    mcpServerId?: string;
    credentialScope: 'personal' | 'team' | 'organization';
    externalAgentId?: string;  // NEW: From X-Archestra-Agent-Id header
    toolCalls: ToolCall[];
  }): Promise<PolicyResult> {

    // Fetch ALL policies for this tool
    const allPolicies = await db
      .select()
      .from(toolInvocationPoliciesTable)
      .where(
        and(
          eq(toolInvocationPoliciesTable.organizationId, context.organizationId),
          eq(toolInvocationPoliciesTable.toolId, context.toolId)
        )
      );

    // Filter policies that match current context
    const applicablePolicies = allPolicies.filter(policy => {
      // Check each condition - if set, must match
      if (policy.condition_profile_id && policy.condition_profile_id !== context.profileId) {
        return false;
      }
      if (policy.condition_team_id && policy.condition_team_id !== context.teamId) {
        return false;
      }
      if (policy.condition_mcp_server_id && policy.condition_mcp_server_id !== context.mcpServerId) {
        return false;
      }
      if (policy.condition_credential_scope && policy.condition_credential_scope !== context.credentialScope) {
        return false;
      }
      if (policy.condition_external_agent_id && policy.condition_external_agent_id !== context.externalAgentId) {
        return false;  // NEW: Filter by external agent ID
      }

      // All conditions matched (or were NULL)
      return true;
    });

    // Evaluate tool calls against applicable policies
    return evaluatePolicyRules(applicablePolicies, context.toolCalls);
  }

  Updated UI

  EXPANDED EDIT VIEW
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edit Tool Policies: database_query                                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #1                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [database â–¼] [equals â–¼] [production]                  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: Dev bots restricted]      â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Apply this policy when:                                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   ğŸ”– External Agent ID: [dev-bot-v1]          [Ã—]         â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   [+ Add Condition]                                        â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #2                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [query â–¼] [contains â–¼] [SELECT * FROM users]          â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   â†’ [Block always â–¼]  [Reason: Prevent full table scan]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Apply this policy when:                                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   (no conditions = applies to all agents)                 â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚   [+ Add Condition]                                        â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy For Tool Parameters]               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  CONDITION DROPDOWN (UPDATED)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Add Condition                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ğŸ‘¤ Specific Profile                    â”‚
  â”‚ ğŸ·ï¸  Specific Team                       â”‚
  â”‚ ğŸ–¥ï¸  Specific MCP Server                â”‚
  â”‚ ğŸ” Credential Scope                    â”‚
  â”‚    â”œâ”€ Personal only                    â”‚
  â”‚    â”œâ”€ Team only                        â”‚
  â”‚    â””â”€ Organization only                â”‚
  â”‚ ğŸ”– External Agent ID                   â”‚  â† NEW
  â”‚    â””â”€ Enter custom ID                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  EXTERNAL AGENT ID INPUT
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ External Agent ID                                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Enter the external agent ID (from X-Archestra-Agent-Id â”‚
  â”‚ header) that this policy should apply to:              â”‚
  â”‚                                                         â”‚
  â”‚ [dev-bot-v1                                          ] â”‚
  â”‚                                                         â”‚
  â”‚ â„¹ï¸  This ID is provided by clients via HTTP header.    â”‚
  â”‚    Leave empty to apply to all external agents.        â”‚
  â”‚                                                         â”‚
  â”‚ Recent external agent IDs in your organization:        â”‚
  â”‚  â€¢ prod-agent                                          â”‚
  â”‚  â€¢ staging-agent                                       â”‚
  â”‚  â€¢ dev-bot-v1                                          â”‚
  â”‚  â€¢ support-bot-tier1                                   â”‚
  â”‚  â€¢ support-bot-tier2                                   â”‚
  â”‚                                                         â”‚
  â”‚ [Cancel]                                    [Add]       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Use Cases for External Agent ID in Policies

  1. Environment-Based Policies

  // Production external agent has strict policies
  condition_external_agent_id: 'prod-agent'
  // Staging/dev agents have relaxed policies
  condition_external_agent_id: 'dev-agent'

  2. Bot Tier Restrictions

  // Tier 1 support bot - limited actions
  condition_external_agent_id: 'support-bot-tier1'
  action: 'block_always' for sensitive operations

  // Tier 2 support bot - more permissions
  condition_external_agent_id: 'support-bot-tier2'
  action: 'allow_when_context_is_untrusted'

  3. Client Application Isolation

  // Mobile app - restrictive policies
  condition_external_agent_id: 'mobile-app-v2'

  // Web dashboard - permissive policies
  condition_external_agent_id: 'web-dashboard'

  4. A/B Testing and Gradual Rollout

  // New policy only for canary external agents
  condition_external_agent_id: 'canary-agent'
  action: 'new_experimental_policy'

  // Old policy for stable external agents
  condition_external_agent_id: 'stable-agent'
  action: 'existing_policy'

  Complete Policy Evaluation Context

  interface PolicyEvaluationContext {
    // Organization & Resource
    organizationId: string;
    toolId: string;
    toolName: string;

    // Subject (Profile/Agent)
    profileId: string;
    profileName: string;
    teamId?: string;

    // Environment
    mcpServerId?: string;

    // Credential
    credentialScope: 'personal' | 'team' | 'organization';
    credentialOwnerId?: string;
    credentialTeamId?: string;

    // External Correlation
    externalAgentId?: string;  // Client-provided identifier
    userId?: string;            // From X-Archestra-User-Id header

    // Tool Call Data
    toolCalls: ToolCall[];
  }

  This gives you the complete ABAC context with external agent ID as just another attribute for policy conditions. Should I proceed with implementing this design?

> here 

If owner equals credential_owner â†’ Mark as trusted           â”‚    â”‚
  â”‚  â”‚    ğŸ“ Applies to: Credential scope: personal only   

should be

 If Credential scope = personal and owner equals credential_owner â†’ Mark as trusted 

âº Exactly! You're absolutely right. The conditions should be part of the policy evaluation logic, not separate "when to apply" filters. Let me redesign this properly.

  Corrected Design: Conditions as Policy Attributes

  Schema Change: Remove Separate Condition Columns

  -- Tool invocation policies - simplified
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    -- Policy rule (can reference context attributes)
    argument_name TEXT NOT NULL,  -- Can be tool argument OR context attribute
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL,
    reason TEXT,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, argument_name, operator, value, action
    )
  );

  -- Same for trusted data policies
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    description TEXT NOT NULL,
    attribute_path TEXT NOT NULL,  -- Can be result attribute OR context attribute
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE NULLS NOT DISTINCT (
      organization_id, tool_id, attribute_path, operator, value, action
    )
  );

  Context Attributes (Reserved Names)

  // Reserved attribute names for context (not tool arguments/results)
  const CONTEXT_ATTRIBUTES = {
    // Profile/Agent
    'context.profile_id': 'string',
    'context.profile_name': 'string',
    'context.team_id': 'string',

    // Credential
    'context.credential_scope': 'personal' | 'team' | 'organization',
    'context.credential_owner_id': 'string',
    'context.credential_team_id': 'string',

    // Environment
    'context.mcp_server_id': 'string',
    'context.mcp_server_name': 'string',

    // External correlation
    'context.external_agent_id': 'string',
    'context.user_id': 'string',
  } as const;

  Policy Examples (Corrected)

  -- Example 1: Block production access for dev external agents
  INSERT INTO tool_invocation_policies VALUES (
    tool_id: 'database_query',
    argument_name: 'context.external_agent_id',  -- Context attribute!
    operator: 'equal',
    value: 'dev-bot-v1',
    action: 'block_always'
  );

  -- Example 2: Your corrected example
  -- If credential scope = personal AND owner equals credential_owner â†’ Mark as trusted
  -- This requires TWO policies that work together:

  -- Policy 2a: Check credential scope
  INSERT INTO trusted_data_policies VALUES (
    tool_id: 'fetch_customer_data',
    attribute_path: 'context.credential_scope',  -- Context attribute!
    operator: 'equal',
    value: 'personal',
    action: 'mark_as_trusted'
  );

  -- Policy 2b: Check owner matches credential
  INSERT INTO trusted_data_policies VALUES (
    tool_id: 'fetch_customer_data',
    attribute_path: 'owner',  -- Result attribute
    operator: 'equal',
    value: '${context.credential_owner_id}',  -- Dynamic value from context!
    action: 'mark_as_trusted'
  );

  Wait, this still requires multiple policies for AND conditions. We need a better approach...

  Better Design: Support Multiple Conditions Per Policy

  -- Tool invocation policies with multiple conditions
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    action TEXT NOT NULL,
    reason TEXT,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  -- Policy conditions (multiple per policy, ALL must match)
  CREATE TABLE tool_invocation_policy_conditions (
    id UUID PRIMARY KEY,
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies(id) ON DELETE CASCADE,

    attribute_name TEXT NOT NULL,  -- Can be argument OR context.* attribute
    operator TEXT NOT NULL,
    value TEXT NOT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE (policy_id, attribute_name, operator, value)
  );

  -- Same pattern for trusted data policies
  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    description TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE trusted_data_policy_conditions (
    id UUID PRIMARY KEY,
    policy_id UUID NOT NULL REFERENCES trusted_data_policies(id) ON DELETE CASCADE,

    attribute_path TEXT NOT NULL,  -- Can be result attribute OR context.* attribute
    operator TEXT NOT NULL,
    value TEXT NOT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE (policy_id, attribute_path, operator, value)
  );

  -- Indexes
  CREATE INDEX idx_tool_invocation_policy_conditions_policy
    ON tool_invocation_policy_conditions(policy_id);

  CREATE INDEX idx_trusted_data_policy_conditions_policy
    ON trusted_data_policy_conditions(policy_id);

  Policy Examples (With Multiple Conditions)

  -- Example 1: Your corrected example
  -- If credential_scope = "personal" AND owner = credential_owner_id â†’ Mark as trusted

  -- Policy
  INSERT INTO trusted_data_policies VALUES (
    id: 'policy-1',
    tool_id: 'fetch_customer_data',
    description: 'Trust personal credential accessing own data',
    action: 'mark_as_trusted'
  );

  -- Condition 1: credential scope must be personal
  INSERT INTO trusted_data_policy_conditions VALUES (
    policy_id: 'policy-1',
    attribute_path: 'context.credential_scope',
    operator: 'equal',
    value: 'personal'
  );

  -- Condition 2: owner must match credential owner
  INSERT INTO trusted_data_policy_conditions VALUES (
    policy_id: 'policy-1',
    attribute_path: 'owner',
    operator: 'equal',
    value: '${context.credential_owner_id}'  -- Dynamic reference
  );


  -- Example 2: Block dev bot from production database
  INSERT INTO tool_invocation_policies VALUES (
    id: 'policy-2',
    tool_id: 'database_query',
    action: 'block_always',
    reason: 'Dev bots cannot access production'
  );

  INSERT INTO tool_invocation_policy_conditions VALUES (
    policy_id: 'policy-2',
    attribute_name: 'context.external_agent_id',
    operator: 'equal',
    value: 'dev-bot-v1'
  );

  INSERT INTO tool_invocation_policy_conditions VALUES (
    policy_id: 'policy-2',
    attribute_name: 'database',
    operator: 'equal',
    value: 'production'
  );


  -- Example 3: Team-specific permissions
  INSERT INTO tool_invocation_policies VALUES (
    id: 'policy-3',
    tool_id: 'send_email',
    action: 'allow_when_context_is_untrusted',
    reason: 'Engineering team can send to external domains'
  );

  INSERT INTO tool_invocation_policy_conditions VALUES (
    policy_id: 'policy-3',
    attribute_name: 'to',
    operator: 'endsWith',
    value: '@external.com'
  );

  INSERT INTO tool_invocation_policy_conditions VALUES (
    policy_id: 'policy-3',
    attribute_name: 'context.team_id',
    operator: 'equal',
    value: 'engineering-team'
  );

  UI (Corrected)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edit Tool Policies: fetch_customer_data                                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Result Policies                                           â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #1: Trust personal credential accessing own data  [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ When ALL of these conditions match:                       â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ 1. [context.credential_scope â–¼] [equals â–¼] [personal]    â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                       [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ 2. [owner â–¼] [equals â–¼] [${context.credential_owner_id}] â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                       [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ Add Condition]                                          â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Then â†’ [Mark as trusted â–¼]                                â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #2: Block external team data                      [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ When ALL of these conditions match:                       â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ 1. [team_id â–¼] [not equal â–¼] [${context.credential_team_id}] â”‚  â”‚
  â”‚  â”‚ â”‚                                                       [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ 2. [context.credential_scope â–¼] [equals â–¼] [team]        â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                       [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ Add Condition]                                          â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ Then â†’ [Mark as untrusted â–¼]                              â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy]                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  ATTRIBUTE DROPDOWN (Shows both tool attributes and context)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Select Attribute                        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ğŸ“Š Result Attributes                   â”‚
  â”‚   â€¢ owner                              â”‚
  â”‚   â€¢ team_id                            â”‚
  â”‚   â€¢ data[*].id                         â”‚
  â”‚   â€¢ created_at                         â”‚
  â”‚                                         â”‚
  â”‚ ğŸ”§ Context Attributes                  â”‚
  â”‚   â€¢ context.profile_id                 â”‚
  â”‚   â€¢ context.team_id                    â”‚
  â”‚   â€¢ context.credential_scope           â”‚
  â”‚   â€¢ context.credential_owner_id        â”‚
  â”‚   â€¢ context.credential_team_id         â”‚
  â”‚   â€¢ context.external_agent_id          â”‚
  â”‚   â€¢ context.mcp_server_id              â”‚
  â”‚   â€¢ context.user_id                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Policy Evaluation Logic

  async function evaluatePolicies(context: PolicyEvaluationContext): Promise<PolicyResult> {
    // Fetch all policies for this tool with their conditions
    const policies = await db
      .select({
        policy: toolInvocationPoliciesTable,
        conditions: sql`json_agg(${toolInvocationPolicyConditionsTable})`,
      })
      .from(toolInvocationPoliciesTable)
      .leftJoin(
        toolInvocationPolicyConditionsTable,
        eq(toolInvocationPoliciesTable.id, toolInvocationPolicyConditionsTable.policyId)
      )
      .where(
        and(
          eq(toolInvocationPoliciesTable.organizationId, context.organizationId),
          eq(toolInvocationPoliciesTable.toolId, context.toolId)
        )
      )
      .groupBy(toolInvocationPoliciesTable.id);

    for (const toolCall of context.toolCalls) {
      for (const { policy, conditions } of policies) {
        // Check if ALL conditions match
        const allConditionsMatch = conditions.every(condition => {
          const attributeValue = getAttributeValue(
            condition.attribute_name,
            toolCall,
            context
          );

          return evaluateOperator(
            attributeValue,
            condition.operator,
            resolveValue(condition.value, context)  // Resolve ${context.*} references
          );
        });

        if (allConditionsMatch) {
          // Apply policy action
          if (policy.action === 'block_always') {
            return { isAllowed: false, reason: policy.reason };
          }
          // ... handle other actions
        }
      }
    }

    return { isAllowed: true };
  }

  function getAttributeValue(
    attributeName: string,
    toolCall: ToolCall,
    context: PolicyEvaluationContext
  ): any {
    // Check if it's a context attribute
    if (attributeName.startsWith('context.')) {
      const contextKey = attributeName.substring(8); // Remove 'context.' prefix
      return context[contextKey];
    }

    // Otherwise, it's a tool argument
    return toolCall.arguments[attributeName];
  }

  function resolveValue(value: string, context: PolicyEvaluationContext): string {
    // Resolve ${context.*} dynamic references
    return value.replace(/\$\{context\.([^}]+)\}/g, (match, key) => {
      return context[key] || '';
    });
  }

  This is the correct design! Policies have multiple conditions that ALL must match (AND logic), and conditions can reference both tool attributes and context attributes. Should I
  implement this?

> in the UI it should look like 
If team = Engineering and external_profile_id = Agent123 and [mail.subject] [contains] [ Confidential] -> 

âº Perfect! Much cleaner. Let me redesign the UI to show conditions inline in a single expression:

  Updated UI Design: Inline Conditions

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edit Tool Policies: send_email                                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Call Policies                                             â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #1                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [context.team_id â–¼] [equals â–¼] [Engineering]          â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ and [context.external_agent_id â–¼] [equals â–¼] [Agent123]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ and [to â–¼] [endsWith â–¼] [@external.com]                  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â†’ Then [Block always â–¼]                                   â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚    Reason: [Engineering team cannot email external]       â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ And condition]                                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #2                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [subject â–¼] [contains â–¼] [urgent]                     â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â†’ Then [Allow when context is untrusted â–¼]               â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚    Reason: [Urgent emails need fast processing]           â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ And condition]                                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy]                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Tool Result Policies                                           â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #1                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [context.credential_scope â–¼] [equals â–¼] [personal]    â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ and [owner â–¼] [equals â–¼] [${context.credential_owner_id}]â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â†’ Then [Mark as trusted â–¼]                                â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚    Description: [Personal credential accessing own data]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ And condition]                                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Policy #2                                                 [Ã—]   â”‚    â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
  â”‚  â”‚ â”‚ If [context.team_id â–¼] [equals â–¼] [Engineering]          â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ and [context.external_agent_id â–¼] [equals â–¼] [Agent123]  â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ and [mail.subject â–¼] [contains â–¼] [Confidential]         â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ â†’ Then [Sanitize with Dual LLM â–¼]                         â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚    Description: [Sanitize confidential emails for Agent123] â”‚  â”‚
  â”‚  â”‚ â”‚                                                            â”‚  â”‚    â”‚
  â”‚  â”‚ â”‚ [+ And condition]                                     [Ã—]  â”‚  â”‚    â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚               [+ Add Policy]                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  COMPACT VIEW (in tools list)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tool Policies                                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ” Search: [_______________]  Filter by: [All tools â–¼]                 â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ send_email                                       [Edit]     â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Tool Call Policies (2)                                          â”‚    â”‚
  â”‚  â”‚  â€¢ If team = Engineering and external_agent_id = Agent123      â”‚    â”‚
  â”‚  â”‚    and to endsWith @external.com â†’ Block always                â”‚    â”‚
  â”‚  â”‚  â€¢ If subject contains urgent â†’ Allow when untrusted           â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Result Policies (2)                                        â”‚    â”‚
  â”‚  â”‚  â€¢ If credential_scope = personal and owner = credential_owner â”‚    â”‚
  â”‚  â”‚    â†’ Mark as trusted                                            â”‚    â”‚
  â”‚  â”‚  â€¢ If team = Engineering and external_agent_id = Agent123      â”‚    â”‚
  â”‚  â”‚    and mail.subject contains Confidential                      â”‚    â”‚
  â”‚  â”‚    â†’ Sanitize with Dual LLM                                     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ğŸ”§ fetch_customer_data                              [Edit]     â”‚    â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
  â”‚  â”‚ Tool Call Policies (1)                                          â”‚    â”‚
  â”‚  â”‚  â€¢ If context.external_agent_id = dev-bot â†’ Block always       â”‚    â”‚
  â”‚  â”‚                                                                 â”‚    â”‚
  â”‚  â”‚ Tool Result Policies (0)                                        â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Component Structure

  // PolicyConditionRow.tsx
  interface PolicyConditionRowProps {
    condition: {
      attributeName: string;
      operator: string;
      value: string;
    };
    isFirst: boolean;
    onUpdate: (updated: Condition) => void;
    onRemove: () => void;
    availableAttributes: Array<{ value: string; label: string }>;
    operators: Array<{ value: string; label: string }>;
  }

  export function PolicyConditionRow({
    condition,
    isFirst,
    onUpdate,
    onRemove,
    availableAttributes,
    operators
  }: PolicyConditionRowProps) {
    return (
      <div className="flex items-center gap-2 flex-wrap">
        {/* Show "If" for first condition, "and" for subsequent */}
        <span className="text-sm font-medium">
          {isFirst ? "If" : "and"}
        </span>

        {/* Attribute selector */}
        <Select
          value={condition.attributeName}
          onValueChange={(value) =>
            onUpdate({ ...condition, attributeName: value })
          }
        >
          <SelectTrigger className="w-[200px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectGroup>
              <SelectLabel>Context Attributes</SelectLabel>
              {availableAttributes
                .filter(attr => attr.value.startsWith('context.'))
                .map(attr => (
                  <SelectItem key={attr.value} value={attr.value}>
                    {attr.label}
                  </SelectItem>
                ))
              }
            </SelectGroup>
            <SelectGroup>
              <SelectLabel>Tool Attributes</SelectLabel>
              {availableAttributes
                .filter(attr => !attr.value.startsWith('context.'))
                .map(attr => (
                  <SelectItem key={attr.value} value={attr.value}>
                    {attr.label}
                  </SelectItem>
                ))
              }
            </SelectGroup>
          </SelectContent>
        </Select>

        {/* Operator selector */}
        <Select
          value={condition.operator}
          onValueChange={(value) =>
            onUpdate({ ...condition, operator: value })
          }
        >
          <SelectTrigger className="w-[140px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {operators.map(op => (
              <SelectItem key={op.value} value={op.value}>
                {op.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* Value input */}
        <DebouncedInput
          className="w-[200px]"
          value={condition.value}
          onChange={(value) =>
            onUpdate({ ...condition, value })
          }
          placeholder="Value"
        />

        {/* Remove button */}
        {!isFirst && (
          <Button
            variant="ghost"
            size="sm"
            onClick={onRemove}
            className="hover:text-red-500"
          >
            <Trash2Icon className="w-4 h-4" />
          </Button>
        )}
      </div>
    );
  }


  // PolicyCard.tsx
  interface PolicyCardProps {
    policy: {
      id: string;
      conditions: Condition[];
      action: string;
      reason?: string;
    };
    onUpdate: (updated: Policy) => void;
    onDelete: () => void;
  }

  export function PolicyCard({ policy, onUpdate, onDelete }: PolicyCardProps) {
    const addCondition = () => {
      onUpdate({
        ...policy,
        conditions: [
          ...policy.conditions,
          { attributeName: '', operator: 'equal', value: '' }
        ]
      });
    };

    const removeCondition = (index: number) => {
      onUpdate({
        ...policy,
        conditions: policy.conditions.filter((_, i) => i !== index)
      });
    };

    return (
      <div className="border rounded-lg p-4 space-y-3">
        {/* Conditions */}
        {policy.conditions.map((condition, index) => (
          <PolicyConditionRow
            key={index}
            condition={condition}
            isFirst={index === 0}
            onUpdate={(updated) => {
              const newConditions = [...policy.conditions];
              newConditions[index] = updated;
              onUpdate({ ...policy, conditions: newConditions });
            }}
            onRemove={() => removeCondition(index)}
            availableAttributes={availableAttributes}
            operators={operators}
          />
        ))}

        {/* Add condition button */}
        <Button
          variant="ghost"
          size="sm"
          onClick={addCondition}
          className="text-muted-foreground"
        >
          <Plus className="w-3.5 h-3.5 mr-1" /> And condition
        </Button>

        {/* Arrow separator */}
        <div className="flex items-center gap-2 pl-4">
          <ArrowRightIcon className="w-4 h-4 text-muted-foreground" />
          <span className="text-sm font-medium">Then</span>
        </div>

        {/* Action */}
        <div className="flex items-center gap-2 pl-8">
          <Select
            value={policy.action}
            onValueChange={(value) =>
              onUpdate({ ...policy, action: value })
            }
          >
            <SelectTrigger className="w-[240px]">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="block_always">Block always</SelectItem>
              <SelectItem value="allow_when_context_is_untrusted">
                Allow when context is untrusted
              </SelectItem>
            </SelectContent>
          </Select>

          {/* Reason */}
          <DebouncedInput
            className="flex-1 min-w-[200px]"
            value={policy.reason || ''}
            onChange={(value) =>
              onUpdate({ ...policy, reason: value })
            }
            placeholder="Reason (optional)"
          />

          {/* Delete policy button */}
          <Button
            variant="ghost"
            size="sm"
            onClick={onDelete}
            className="hover:text-red-500"
          >
            <Trash2Icon className="w-4 h-4" />
          </Button>
        </div>
      </div>
    );
  }

  Context Attribute Helpers

  // Available context attributes for dropdown
  export const CONTEXT_ATTRIBUTES = [
    // Profile/Agent
    { value: 'context.profile_id', label: 'Profile ID', type: 'string' },
    { value: 'context.profile_name', label: 'Profile Name', type: 'string' },
    { value: 'context.team_id', label: 'Team', type: 'string' },

    // Credential
    { value: 'context.credential_scope', label: 'Credential Scope', type: 'enum',
      options: ['personal', 'team', 'organization'] },
    { value: 'context.credential_owner_id', label: 'Credential Owner ID', type: 'string' },
    { value: 'context.credential_team_id', label: 'Credential Team ID', type: 'string' },

    // Environment
    { value: 'context.mcp_server_id', label: 'MCP Server ID', type: 'string' },
    { value: 'context.mcp_server_name', label: 'MCP Server Name', type: 'string' },

    // External
    { value: 'context.external_agent_id', label: 'External Agent ID', type: 'string' },
    { value: 'context.user_id', label: 'User ID', type: 'string' },
  ] as const;

  // Format policy for display (compact view)
  export function formatPolicyDisplay(policy: Policy): string {
    const conditions = policy.conditions.map((c, i) => {
      const prefix = i === 0 ? 'If' : 'and';
      const attr = c.attributeName.replace('context.', '');
      const op = formatOperator(c.operator);
      return `${prefix} ${attr} ${op} ${c.value}`;
    }).join(' ');

    const action = formatAction(policy.action);

    return `${conditions} â†’ ${action}`;
  }

  function formatOperator(op: string): string {
    const map: Record<string, string> = {
      'equal': '=',
      'notEqual': '!=',
      'contains': 'contains',
      'notContains': 'not contains',
      'startsWith': 'starts with',
      'endsWith': 'ends with',
      'regex': 'matches',
    };
    return map[op] || op;
  }

  This gives you exactly the inline condition format you wanted: If team = Engineering and external_agent_id = Agent123 and [mail.subject] [contains] [Confidential] â†’ ...

  Should I proceed with implementing this design?

> what about the migration? is it going to be complex? 

âº Let me analyze the migration complexity:

  Migration Analysis

  Current Schema â†’ New Schema Transformation

  CURRENT:
  tool_invocation_policies (
    id,
    agent_tool_id,  -- FK to agent_tools (profile + tool)
    argument_name,
    operator,
    value,
    action,
    reason
  )

  NEW:
  tool_invocation_policies (
    id,
    organization_id,
    tool_id,  -- Just tool, no profile!
    action,
    reason
  )

  tool_invocation_policy_conditions (
    id,
    policy_id,
    attribute_name,  -- Can be 'context.profile_id' for profile-specific
    operator,
    value
  )

  Migration Complexity: MEDIUM âš ï¸

  Migration Steps

  Step 1: Schema Changes (Straightforward)

  -- Create new tables
  CREATE TABLE tool_invocation_policies_new (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE tool_invocation_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies_new(id) ON DELETE CASCADE,
    attribute_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_name, operator, value)
  );

  -- Same for trusted_data_policies

  Step 2: Data Migration (Complex - Requires Deduplication)

  -- Migration script logic:

  -- 1. For each existing policy, extract context
  WITH policy_context AS (
    SELECT
      tip.id as old_policy_id,
      tip.argument_name,
      tip.operator,
      tip.value,
      tip.action,
      tip.reason,
      at.tool_id,
      at.agent_id as profile_id,
      a.organization_id,
      COUNT(*) OVER (
        PARTITION BY at.tool_id, tip.argument_name, tip.operator, tip.value, tip.action
      ) as duplicate_count
    FROM tool_invocation_policies tip
    JOIN agent_tools at ON tip.agent_tool_id = at.id
    JOIN agents a ON at.agent_id = a.id
  )

  -- 2. Identify policies that are IDENTICAL across all profiles (can be tool-level defaults)
  SELECT
    tool_id,
    argument_name,
    operator,
    value,
    action,
    COUNT(DISTINCT profile_id) as profile_count,
    (SELECT COUNT(DISTINCT agent_id) FROM agent_tools WHERE tool_id = pc.tool_id) as total_profiles
  FROM policy_context pc
  GROUP BY tool_id, argument_name, operator, value, action
  HAVING COUNT(DISTINCT profile_id) = (
    SELECT COUNT(DISTINCT agent_id)
    FROM agent_tools
    WHERE tool_id = pc.tool_id
  )
  -- These policies are universal â†’ migrate as tool-level defaults (no conditions)


  -- 3. Identify policies that are PROFILE-SPECIFIC
  SELECT
    tool_id,
    argument_name,
    operator,
    value,
    action,
    profile_id
  FROM policy_context pc
  WHERE NOT EXISTS (
    -- Not a universal policy
    SELECT 1 FROM policy_context pc2
    WHERE pc2.tool_id = pc.tool_id
      AND pc2.argument_name = pc.argument_name
      AND pc2.operator = pc.operator
      AND pc2.value = pc.value
      AND pc2.action = pc.action
      AND pc2.profile_id != pc.profile_id
  )
  -- These policies need 'context.profile_id' condition

  Step 3: Migration Script Implementation

  // backend/src/database/migrations/0xxx_refactor_policies.ts

  import { db } from '../db';
  import * as schema from '../schemas';

  interface OldPolicy {
    id: string;
    agentToolId: string;
    argumentName: string;
    operator: string;
    value: string;
    action: string;
    reason: string | null;
    toolId: string;
    profileId: string;
    organizationId: string;
  }

  interface PolicyGroup {
    toolId: string;
    argumentName: string;
    operator: string;
    value: string;
    action: string;
    reason: string | null;
    profileIds: string[];
    totalProfilesForTool: number;
  }

  async function migratePolicies() {
    console.log('Starting policy migration...');

    // 1. Fetch all existing policies with context
    const oldPolicies = await db
      .select({
        id: schema.toolInvocationPoliciesTable.id,
        agentToolId: schema.toolInvocationPoliciesTable.agentToolId,
        argumentName: schema.toolInvocationPoliciesTable.argumentName,
        operator: schema.toolInvocationPoliciesTable.operator,
        value: schema.toolInvocationPoliciesTable.value,
        action: schema.toolInvocationPoliciesTable.action,
        reason: schema.toolInvocationPoliciesTable.reason,
        toolId: schema.agentToolsTable.toolId,
        profileId: schema.agentToolsTable.agentId,
        organizationId: schema.agentsTable.organizationId,
      })
      .from(schema.toolInvocationPoliciesTable)
      .innerJoin(
        schema.agentToolsTable,
        eq(schema.toolInvocationPoliciesTable.agentToolId, schema.agentToolsTable.id)
      )
      .innerJoin(
        schema.agentsTable,
        eq(schema.agentToolsTable.agentId, schema.agentsTable.id)
      );

    // 2. Group policies by their rule (same tool + argument + operator + value + action)
    const policyGroups = new Map<string, PolicyGroup>();

    for (const policy of oldPolicies) {
      const key = `${policy.toolId}:${policy.argumentName}:${policy.operator}:${policy.value}:${policy.action}`;

      if (!policyGroups.has(key)) {
        // Count total profiles using this tool
        const totalProfiles = await db
          .select({ count: sql`COUNT(DISTINCT agent_id)` })
          .from(schema.agentToolsTable)
          .where(eq(schema.agentToolsTable.toolId, policy.toolId));

        policyGroups.set(key, {
          toolId: policy.toolId,
          argumentName: policy.argumentName,
          operator: policy.operator,
          value: policy.value,
          action: policy.action,
          reason: policy.reason,
          profileIds: [],
          totalProfilesForTool: totalProfiles[0].count,
        });
      }

      policyGroups.get(key)!.profileIds.push(policy.profileId);
    }

    // 3. Migrate each group
    let universalPolicies = 0;
    let profileSpecificPolicies = 0;

    for (const [key, group] of policyGroups.entries()) {
      const isUniversal = group.profileIds.length === group.totalProfilesForTool;

      if (isUniversal) {
        // Create tool-level policy (no conditions)
        const [newPolicy] = await db
          .insert(schema.toolInvocationPoliciesNewTable)
          .values({
            organizationId: oldPolicies.find(p => p.toolId === group.toolId)!.organizationId,
            toolId: group.toolId,
            action: group.action,
            reason: group.reason,
          })
          .returning();

        // Add single condition for the argument
        await db
          .insert(schema.toolInvocationPolicyConditionsTable)
          .values({
            policyId: newPolicy.id,
            attributeName: group.argumentName,
            operator: group.operator,
            value: group.value,
          });

        universalPolicies++;
        console.log(`  Migrated universal policy: ${key}`);
      } else {
        // Create profile-specific policies
        for (const profileId of group.profileIds) {
          const [newPolicy] = await db
            .insert(schema.toolInvocationPoliciesNewTable)
            .values({
              organizationId: oldPolicies.find(p => p.profileId === profileId)!.organizationId,
              toolId: group.toolId,
              action: group.action,
              reason: group.reason,
            })
            .returning();

          // Add conditions: profile_id + argument
          await db
            .insert(schema.toolInvocationPolicyConditionsTable)
            .values([
              {
                policyId: newPolicy.id,
                attributeName: 'context.profile_id',
                operator: 'equal',
                value: profileId,
              },
              {
                policyId: newPolicy.id,
                attributeName: group.argumentName,
                operator: group.operator,
                value: group.value,
              },
            ]);

          profileSpecificPolicies++;
        }
        console.log(`  Migrated profile-specific policies: ${key} (${group.profileIds.length} profiles)`);
      }
    }

    console.log(`Migration complete:`);
    console.log(`  Universal policies: ${universalPolicies}`);
    console.log(`  Profile-specific policies: ${profileSpecificPolicies}`);
    console.log(`  Original policies: ${oldPolicies.length}`);
    console.log(`  Reduction: ${oldPolicies.length - universalPolicies - profileSpecificPolicies}`);
  }

  Migration Complexity Assessment

  | Aspect              | Complexity | Notes                                        |
  |---------------------|------------|----------------------------------------------|
  | Schema changes      | âœ… Low      | Straightforward table creation               |
  | Data transformation | âš ï¸ Medium  | Need to analyze policy duplication patterns  |
  | Deduplication logic | âš ï¸ Medium  | Must identify universal vs profile-specific  |
  | Data integrity      | âœ… Low      | All relationships preserved                  |
  | Rollback            | âœ… Low      | Keep old tables until verified               |
  | Performance         | âš ï¸ Medium  | May take time for large policy counts        |
  | Testing             | âš ï¸ Medium  | Need to verify policy evaluation still works |

  Migration Safety Approach

  Phase 1: Additive (Zero Downtime)

  -- Create new tables alongside old ones
  -- Old system continues working
  CREATE TABLE tool_invocation_policies_new ...;
  CREATE TABLE tool_invocation_policy_conditions ...;

  Phase 2: Dual Write (Transition)

  // Update code to write to BOTH old and new schemas
  async function createPolicy(policy: PolicyInput) {
    // Write to old schema
    await db.insert(oldPoliciesTable).values(...);

    // Write to new schema
    await db.insert(newPoliciesTable).values(...);
    await db.insert(conditionsTable).values(...);
  }

  Phase 3: Dual Read (Verification)

  // Evaluate policies from BOTH schemas and compare results
  async function evaluatePolicies(context: Context) {
    const oldResult = await evaluateOldSchema(context);
    const newResult = await evaluateNewSchema(context);

    // Log discrepancies for debugging
    if (!resultsMatch(oldResult, newResult)) {
      logger.error('Policy evaluation mismatch', { oldResult, newResult });
    }

    // Return old result (safe)
    return oldResult;
  }

  Phase 4: Switch (Low Risk)

  // Feature flag to switch to new schema
  if (config.useNewPolicySchema) {
    return evaluateNewSchema(context);
  } else {
    return evaluateOldSchema(context);
  }

  Phase 5: Cleanup (After Verification)

  -- Drop old tables after successful migration
  DROP TABLE tool_invocation_policies;
  DROP TABLE trusted_data_policies;

  -- Rename new tables
  ALTER TABLE tool_invocation_policies_new RENAME TO tool_invocation_policies;
  ALTER TABLE trusted_data_policies_new RENAME TO trusted_data_policies;

  Expected Outcome

  Before Migration:
  100 policies total:
  - Profile A + Tool 1: 5 policies
  - Profile B + Tool 1: 5 policies (duplicates)
  - Profile C + Tool 1: 5 policies (duplicates)
  - Profile D + Tool 1: 3 policies (different!)
  - ... (repeated for other tools)

  After Migration:
  25 policies total:
  - Tool 1: 5 universal policies (apply to A, B, C)
  - Tool 1: 3 policies with condition "profile_id = D" (D's exceptions)
  - ... (75% reduction!)

  Risks and Mitigations

  | Risk                                    | Likelihood | Impact   | Mitigation                                  |
  |-----------------------------------------|------------|----------|---------------------------------------------|
  | Policy evaluation breaks                | Low        | High     | Dual-read verification phase                |
  | Data loss during migration              | Very Low   | Critical | Keep old tables, transactional migration    |
  | Performance degradation                 | Medium     | Medium   | Index on conditions, benchmark before/after |
  | Complex policies not migrated correctly | Medium     | Medium   | Manual review of edge cases                 |

  Recommendation

  Migration complexity: MEDIUM - Doable with proper planning.

  Recommended approach:
  1. âœ… Implement dual-write first (write to both schemas)
  2. âœ… Run migration script in staging
  3. âœ… Enable dual-read with comparison logging
  4. âœ… Monitor for discrepancies for 1-2 weeks
  5. âœ… Switch to new schema via feature flag
  6. âœ… Keep old tables for 30 days as backup
  7. âœ… Drop old tables after verification

  Timeline estimate:
  - Schema + migration script: 2-3 days
  - Dual-write implementation: 1-2 days
  - Testing + verification: 1 week
  - Production rollout: 2 weeks (cautious)
  - Total: 3-4 weeks for safe migration

  Should I proceed with implementing the migration?

> instead of complex migration, can we just take it from one profile? 

âº Brilliant idea! Much simpler. Just pick one profile's policies as the baseline and discard the rest.

  Simple Migration: Pick One Profile

  Migration Script (Very Simple)

  // backend/src/database/migrations/0xxx_refactor_policies_simple.ts

  async function migratePolicies() {
    console.log('Starting simple policy migration...');

    // Strategy: For each tool, pick policies from the FIRST profile that has them

    // 1. Get all unique tools that have policies
    const toolsWithPolicies = await db
      .selectDistinct({
        toolId: schema.agentToolsTable.toolId,
        organizationId: schema.agentsTable.organizationId,
      })
      .from(schema.toolInvocationPoliciesTable)
      .innerJoin(
        schema.agentToolsTable,
        eq(schema.toolInvocationPoliciesTable.agentToolId, schema.agentToolsTable.id)
      )
      .innerJoin(
        schema.agentsTable,
        eq(schema.agentToolsTable.agentId, schema.agentsTable.id)
      );

    let migratedCount = 0;

    // 2. For each tool, get policies from first profile
    for (const { toolId, organizationId } of toolsWithPolicies) {
      // Get the first agent_tool_id for this tool
      const firstAgentTool = await db
        .select({ agentToolId: schema.agentToolsTable.id })
        .from(schema.agentToolsTable)
        .innerJoin(
          schema.agentsTable,
          eq(schema.agentToolsTable.agentId, schema.agentsTable.id)
        )
        .where(
          and(
            eq(schema.agentToolsTable.toolId, toolId),
            eq(schema.agentsTable.organizationId, organizationId)
          )
        )
        .orderBy(schema.agentToolsTable.createdAt)
        .limit(1);

      if (!firstAgentTool[0]) continue;

      // Get all policies for this agent_tool
      const policiesToMigrate = await db
        .select()
        .from(schema.toolInvocationPoliciesTable)
        .where(
          eq(schema.toolInvocationPoliciesTable.agentToolId, firstAgentTool[0].agentToolId)
        );

      // Migrate each policy
      for (const oldPolicy of policiesToMigrate) {
        // Create new policy (tool-level, no profile condition)
        const [newPolicy] = await db
          .insert(schema.toolInvocationPoliciesNewTable)
          .values({
            organizationId,
            toolId,
            action: oldPolicy.action,
            reason: oldPolicy.reason,
          })
          .returning();

        // Add single condition for the argument
        await db
          .insert(schema.toolInvocationPolicyConditionsTable)
          .values({
            policyId: newPolicy.id,
            attributeName: oldPolicy.argumentName,
            operator: oldPolicy.operator,
            value: oldPolicy.value,
          });

        migratedCount++;
      }
    }

    // Same for trusted_data_policies
    // ... (same pattern)

    console.log(`Migration complete:`);
    console.log(`  Migrated ${migratedCount} tool invocation policies`);
    console.log(`  All other profile-specific policies discarded`);
  }

  Even Simpler: Copy from Admin's First Profile

  async function migratePoliciesFromAdmin() {
    // For each organization, find the first admin user's first profile
    const adminProfiles = await db
      .select({
        organizationId: schema.organizationsTable.id,
        agentId: schema.agentsTable.id,
      })
      .from(schema.organizationsTable)
      .innerJoin(
        schema.membersTable,
        and(
          eq(schema.membersTable.organizationId, schema.organizationsTable.id),
          eq(schema.membersTable.role, 'admin')
        )
      )
      .innerJoin(
        schema.agentsTable,
        eq(schema.agentsTable.organizationId, schema.organizationsTable.id)
      )
      .orderBy(
        schema.organizationsTable.id,
        schema.membersTable.createdAt,
        schema.agentsTable.createdAt
      )
      .distinctOn(schema.organizationsTable.id);

    for (const { organizationId, agentId } of adminProfiles) {
      // Get all policies for this profile's tools
      const policies = await db
        .select({
          policy: schema.toolInvocationPoliciesTable,
          toolId: schema.agentToolsTable.toolId,
        })
        .from(schema.toolInvocationPoliciesTable)
        .innerJoin(
          schema.agentToolsTable,
          eq(schema.toolInvocationPoliciesTable.agentToolId, schema.agentToolsTable.id)
        )
        .where(eq(schema.agentToolsTable.agentId, agentId));

      // Convert to tool-level policies
      for (const { policy, toolId } of policies) {
        const [newPolicy] = await db
          .insert(schema.toolInvocationPoliciesNewTable)
          .values({
            organizationId,
            toolId,
            action: policy.action,
            reason: policy.reason,
          })
          .returning();

        await db
          .insert(schema.toolInvocationPolicyConditionsTable)
          .values({
            policyId: newPolicy.id,
            attributeName: policy.argumentName,
            operator: policy.operator,
            value: policy.value,
          });
      }
    }
  }

  Super Simple: Just Reset Policies

  -- Migration: 0xxx_refactor_policies_reset.sql

  -- 1. Create new tables
  CREATE TABLE tool_invocation_policies_new (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE tool_invocation_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies_new(id) ON DELETE CASCADE,
    attribute_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_name, operator, value)
  );

  CREATE INDEX idx_tool_invocation_policies_tool
    ON tool_invocation_policies_new(organization_id, tool_id);

  CREATE INDEX idx_tool_invocation_policy_conditions_policy
    ON tool_invocation_policy_conditions(policy_id);

  -- Same for trusted_data_policies
  CREATE TABLE trusted_data_policies_new (...);
  CREATE TABLE trusted_data_policy_conditions (...);

  -- 2. Drop old tables (policies reset!)
  DROP TABLE tool_invocation_policies CASCADE;
  DROP TABLE trusted_data_policies CASCADE;

  -- 3. Rename new tables
  ALTER TABLE tool_invocation_policies_new RENAME TO tool_invocation_policies;
  ALTER TABLE trusted_data_policies_new RENAME TO trusted_data_policies;

  -- Done! Users will recreate policies from scratch at tool level

  User Communication

  Option 1: Migration with First Profile

  Subject: Policy System Upgrade - Simplified Management

  Dear Archestra User,

  We've upgraded the policy system to eliminate duplication and
  simplify management.

  WHAT CHANGED:
  - Policies are now managed at the tool level (not per profile)
  - One policy applies to all profiles using that tool
  - Profile-specific exceptions can still be created when needed

  MIGRATION:
  - We migrated policies from your first profile for each tool
  - Other profile-specific policies were removed
  - Please review your tool policies and adjust as needed

  ACTION REQUIRED:
  - Review policies at /tools
  - Add any profile-specific exceptions if needed

  This change reduces policy duplication by 70-90% on average.

  Questions? Contact support@archestra.ai

  Option 2: Clean Slate (Recommended for Simplicity)

  Subject: Policy System Upgrade - Action Required

  Dear Archestra User,

  We've upgraded the policy system with a major improvement:

  NEW APPROACH:
  - Policies are now configured once per tool (not per profile)
  - All profiles inherit tool policies automatically
  - Profile-specific exceptions available when needed

  âš ï¸ ACTION REQUIRED:
  - All existing policies have been reset
  - Please reconfigure policies at the tool level: /tools
  - Much faster than before - configure once, applies everywhere!

  WHY THE RESET:
  - Old system had 10x duplication (same policy Ã— every profile)
  - Clean migration would be complex and error-prone
  - Starting fresh is faster and cleaner

  BENEFITS:
  - 90% less configuration effort
  - Consistent policies across profiles
  - Easy to manage exceptions

  Need help? We can assist with policy configuration.
  Contact: support@archestra.ai

  Recommendation

âº I recommend: Clean Slate (Option 2)

  Why:
  1. âœ… Simplest migration - 10 lines of SQL vs 200 lines of complex logic
  2. âœ… No edge cases - No risk of incorrect migration
  3. âœ… Fresh start - Users understand the new model immediately
  4. âœ… Faster for users - Reconfiguring at tool-level is 10x faster than old way
  5. âœ… Better outcome - Forces users to think tool-first, not profile-first

  Trade-off:
  - Users need to reconfigure policies
  - But it's much LESS work than before (one policy per tool vs one per profile-tool combination)

  Implementation:
  -- Single migration file, runs in <1 second
  DROP TABLE tool_invocation_policies CASCADE;
  DROP TABLE trusted_data_policies CASCADE;
  CREATE TABLE tool_invocation_policies (...);
  CREATE TABLE tool_invocation_policy_conditions (...);
  CREATE TABLE trusted_data_policies (...);
  CREATE TABLE trusted_data_policy_conditions (...);

  Want me to implement this simple approach?

> ok, let's take option 2 

âº Perfect! Let me implement the clean slate migration approach.

âº Great! Let me start implementing the clean slate migration. First, let me check the current migration files to understand the naming convention:

âº Bash(ls -la backend/src/database/migrations/ | tail -20)
  â¿ Â -rw-r--r--   1 ildar  staff  3734 17 Dec 22:47 0077_secret_lethal_legion.sql
     -rw-r--r--   1 ildar  staff    58 17 Dec 22:47 0078_wakeful_nightcrawler.sql
     -rw-r--r--   1 ildar  staff   592 17 Dec 22:47 0079_mature_deathbird.sql
     â€¦ +17 lines (ctrl+o to expand)

âº Read(backend/src/database/migrations/0095_optimal_xorn.sql)
  â¿ Â Read 8 lines

âº Now let me create the migration file:
  â¿ Â Interrupted Â· What should Claude do instead?

> can you return the plan first 

âº Absolutely! Let me present the complete implementation plan first.

  Implementation Plan: Policy Refactoring (Clean Slate Migration)

  Phase 1: Database Schema Changes

  Files to create/modify:
  1. backend/src/database/migrations/0096_refactor_policies.sql
    - Drop old tables: tool_invocation_policies, trusted_data_policies
    - Create new tables: tool_invocation_policies, tool_invocation_policy_conditions
    - Create new tables: trusted_data_policies, trusted_data_policy_conditions
  2. backend/src/database/schemas/tool-invocation-policy.ts
    - Update schema to new structure (policies + conditions)
    - Remove agentToolId field
    - Add organizationId, toolId fields
  3. backend/src/database/schemas/trusted-data-policy.ts
    - Same pattern as tool-invocation-policy
  4. backend/src/database/schemas/tool-invocation-policy-condition.ts (NEW)
    - Define conditions schema
  5. backend/src/database/schemas/trusted-data-policy-condition.ts (NEW)
    - Define conditions schema
  6. backend/src/database/schemas/index.ts
    - Export new condition tables

  Phase 2: Backend Types & Utilities

  Files to create/modify:
  7. shared/types/autonomy-policies/context-attributes.ts (NEW)
  - Define context attribute constants (context.profile_id, context.team_id, etc.)
  - Define allowed context attributes enum

  8. backend/src/types/autonomy-policies/tool-invocation.ts
    - Update types to include conditions[] array
    - Remove agentToolId references
  9. backend/src/types/autonomy-policies/trusted-data.ts
    - Same pattern as tool-invocation
  10. backend/src/utils/policy-evaluation-context.ts (NEW)
    - Helper to build evaluation context from request
    - Extract profile, team, credential, external_agent_id, etc.

  Phase 3: Backend Models

  Files to modify:
  11. backend/src/models/tool-invocation-policy.ts
      - Update create() to accept conditions array
      - Update findAll() to fetch with conditions joined
      - Update findById() to include conditions
      - Update update() to handle condition updates
      - Update delete() to cascade to conditions
      - Rewrite evaluateBatch() to support new condition-based evaluation

  12. backend/src/models/trusted-data-policy.ts
    - Same changes as tool-invocation-policy
    - Rewrite evaluate() and evaluateBulk()
  13. backend/src/models/agent-tool.ts
    - Remove policy auto-configuration cleanup logic (lines referencing policiesAutoConfiguredAt)
    - Keep the fields in schema for now (can clean up later)

  Phase 4: Backend API Routes

  Files to modify:
  14. backend/src/routes/autonomy-policies.ts
      - Update all CRUD endpoints to work with new schema
      - GET /api/autonomy-policies/tool-invocation - filter by toolId instead of agentToolId
      - POST /api/autonomy-policies/tool-invocation - accept conditions[] array
      - PUT /api/autonomy-policies/tool-invocation/:id - update with conditions
      - Same for trusted data policy endpoints

  15. backend/src/routes/proxy/utils/tool-invocation.ts
    - Update evaluatePolicies() to pass full context (team, credential, external_agent_id)
  16. backend/src/routes/proxy/utils/trusted-data.ts
    - Update evaluateIfContextIsTrusted() to pass full context
  17. backend/src/routes/proxy/openai.ts, anthropic.ts, gemini.ts
    - Extract externalAgentId from headers
    - Pass to policy evaluation functions

  Phase 5: Shared API Types

  Files to modify:
  18. shared/api-types.ts or equivalent
      - Update request/response types for policy endpoints
      - Add conditions array to policy types
      - Remove agentToolId from types

  Phase 6: Frontend Query Hooks

  Files to modify:
  19. frontend/src/lib/policy.query.ts
      - Update hooks to work with tool-level policies
      - Change byProfileToolId to byToolId grouping
      - Update mutations to send conditions[] array
      - Add query param toolId filter

  20. frontend/src/lib/policy.utils.ts
    - Update transformation functions
    - Remove profile-tool grouping
    - Add tool-level grouping

  Phase 7: Frontend Components (Major Refactor)

  Files to modify:
  21. frontend/src/app/tools/page.tsx
      - Update to fetch policies by tool, not by agent-tool
      - Remove byProfileToolId references

  22. frontend/src/app/tools/page.client.tsx
    - Update to pass tool-level policies to components
  23. frontend/src/app/tools/_parts/tool-call-policies.tsx
    - Major refactor: Change from profile-tool view to tool view
    - Remove agentTool prop, accept tool prop
    - Implement inline condition UI with "If ... and ... and ... â†’ Then" format
  24. frontend/src/app/tools/_parts/tool-result-policies.tsx
    - Same major refactor as tool-call-policies

  Files to create:
  25. frontend/src/app/tools/_parts/policy-condition-row.tsx (NEW)
      - Component for each condition row
      - Shows "If" for first, "and" for others
      - Attribute selector with context attributes

  26. frontend/src/app/tools/_parts/policy-card.tsx (UPDATE)
    - Update to work with conditions array
    - Add "Add condition" button
  27. frontend/src/lib/context-attributes.ts (NEW)
    - Frontend constants for context attributes
    - Dropdown options with labels

  Phase 8: Archestra MCP Server Tools

  Files to modify:
  28. backend/src/archestra-mcp-server.ts
      - Update policy management tools (10 tools total)
      - Change from agentToolId parameter to toolId parameter
      - Update tool schemas to include conditions array

  Phase 9: Tests

  Files to modify:
  29. backend/src/models/tool-invocation-policy.test.ts
      - Rewrite tests for new condition-based evaluation
      - Test context attribute matching

  30. backend/src/models/trusted-data-policy.test.ts
    - Same as tool-invocation tests
  31. backend/src/routes/proxy/utils/trusted-data.test.ts
    - Update to pass full context
  32. e2e-tests/tests/api/llm-proxy/tool-invocation.spec.ts
    - Update to create policies at tool level
    - Test with different context attributes
  33. backend/src/test/fixtures.ts
    - Update makeToolPolicy() and makeTrustedDataPolicy() fixtures
    - Accept conditions[] parameter

  Phase 10: Documentation & Communication

  Files to create:
  34. POLICY_MIGRATION.md (NEW)
      - Document the breaking change
      - Explain new policy model
      - Migration guide for users

  35. Update API documentation
    - Document new endpoints
    - Document context attributes
    - Add examples

  Phase 11: Cleanup (Optional, can be done later)

  Files to modify:
  36. backend/src/database/schemas/agent-tool.ts
      - Remove policy auto-configuration fields (can be separate migration later)
      - policiesAutoConfiguredAt
      - policiesAutoConfiguringStartedAt
      - policiesAutoConfiguredReasoning

  Summary

  Total files to modify: ~35 files

  Breakdown:
  - Database: 6 files (1 migration + 5 schema files)
  - Backend types: 3 files
  - Backend models: 3 files
  - Backend routes: 6 files
  - Shared types: 1 file
  - Frontend hooks: 2 files
  - Frontend components: 7 files
  - Archestra tools: 1 file
  - Tests: 5 files
  - Documentation: 1 file

  Estimated effort:
  - Database + types: 2-3 hours
  - Backend models + routes: 4-5 hours
  - Frontend: 5-6 hours
  - Tests: 2-3 hours
  - Documentation: 1 hour
  - Total: 14-18 hours (~2-3 days)

  Risk areas:
  1. âš ï¸ Policy evaluation logic changes (most critical)
  2. âš ï¸ Frontend UI refactor (most time-consuming)
  3. âš ï¸ Test updates (comprehensive coverage needed)

  Dependencies:
  - Phase 1 must complete first (database)
  - Phases 2-4 can happen in parallel (backend)
  - Phase 6-7 depend on phase 5 (frontend depends on types)
  - Phase 8-9 depend on phases 1-4 (tools/tests depend on backend)

  Should I proceed with this plan?

> where now credentials setting will be stored 

âº Great question! Credential settings are currently stored in the agent_tools table. Let me clarify what happens to them:

âº Read(backend/src/database/schemas/agent-tool.ts)
  â¿ Â Read 67 lines

âº Credential Settings: No Change Needed!

  Answer: Credential settings stay exactly where they are - in the agent_tools table.

  What Stays in agent_tools Table

  agent_tools {
    id
    agentId                              // Profile
    toolId                                // Tool

    // CREDENTIAL SETTINGS - UNCHANGED
    credentialSourceMcpServerId           âœ… Stays here
    executionSourceMcpServerId            âœ… Stays here
    useDynamicTeamCredential              âœ… Stays here

    // TOOL CONFIGURATION - STAYS (but might move to policies)
    allowUsageWhenUntrustedDataIsPresent  âš ï¸ Could become a policy, but keep for now
    toolResultTreatment                   âš ï¸ Could become a policy, but keep for now
    responseModifierTemplate              âœ… Stays here (not a policy)

    // POLICY AUTO-CONFIG - CAN BE REMOVED LATER
    policiesAutoConfiguredAt              âŒ Not needed anymore
    policiesAutoConfiguringStartedAt      âŒ Not needed anymore
    policiesAutoConfiguredReasoning       âŒ Not needed anymore
  }

  Why Credentials Stay in agent_tools

  1. Credentials are profile-tool specific - Each profile can use different credentials for the same tool
  2. Not a policy concern - Credentials determine execution, not authorization
  3. Already works well - No reason to change this design

  The Separation of Concerns

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ agent_tools table (Profile-Tool Assignment)                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Which tools does this profile have access to?             â”‚
  â”‚ â€¢ Which credential to use? (static or dynamic)              â”‚
  â”‚ â€¢ Which MCP server pod to route to? (for local servers)     â”‚
  â”‚ â€¢ Response modifiers (Handlebars templates)                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies (Tool-level Security Rules)        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Can this tool be called with these arguments?             â”‚
  â”‚ â€¢ Context-aware conditions (team, credential scope, etc.)   â”‚
  â”‚ â€¢ Block/allow decisions                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ trusted_data_policies (Tool Result Trust Rules)             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Should we trust this tool's output?                       â”‚
  â”‚ â€¢ Context-aware conditions (team, credential scope, etc.)   â”‚
  â”‚ â€¢ Trust/sanitize/block decisions                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Updated Implementation Plan

  Phase 1 Addition:
  - Keep agent_tools table unchanged
  - Only drop policy tables

  Updated Migration:
  -- 0096_refactor_policies.sql

  -- Drop ONLY policy tables
  DROP TABLE IF EXISTS tool_invocation_policies CASCADE;
  DROP TABLE IF EXISTS trusted_data_policies CASCADE;

  -- Create new policy tables
  CREATE TABLE tool_invocation_policies (...);
  CREATE TABLE tool_invocation_policy_conditions (...);
  CREATE TABLE trusted_data_policies (...);
  CREATE TABLE trusted_data_policy_conditions (...);

  -- agent_tools table is UNCHANGED
  -- Credentials, execution routing, response modifiers all stay there

  Optional Future Cleanup (Separate Task)

  You could later move these fields from agent_tools to policies:

  -- Could become policies instead of table columns:
  -- allowUsageWhenUntrustedDataIsPresent â†’ Tool invocation policy
  -- toolResultTreatment â†’ Trusted data policy default action

  -- But this is optional and separate from the main refactoring

  Frontend Tool Assignment UI

  The tool assignment UI stays the same:

  // When assigning a tool to a profile, user still configures:
  {
    agentId: "profile-123",
    toolId: "tool-456",
    credentialSourceMcpServerId: "server-789",     // Still here
    executionSourceMcpServerId: "server-789",       // Still here
    useDynamicTeamCredential: false,                // Still here
    responseModifierTemplate: "{{json result}}",    // Still here
  }

  // Policies are managed separately at tool level (not during assignment)

  Summary

  âœ… Credentials stay in agent_tools table
  âœ… No changes to credential management
  âœ… Only policies move to tool-level
  âœ… Clear separation: assignment vs. policy

  Does this clarify the design? Should I proceed with implementation?

> responseModifierTemplate should also be per tool

these are per profile
 credentialSourceMcpServerId           âœ… Stays here
    executionSourceMcpServerId            âœ… Stays here
    useDynamicTeamCredential              âœ… Stays here 

âº You're absolutely right! Let me correct the design:

  Correct Separation: Per-Tool vs Per-Profile

  What Should Move to Tool Level

  -- NEW: tool_config table (tool-level settings)
  CREATE TABLE tool_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    -- Tool-level settings (same for all profiles using this tool)
    response_modifier_template TEXT,
    allow_usage_when_untrusted_data_is_present BOOLEAN NOT NULL DEFAULT false,
    tool_result_treatment TEXT NOT NULL DEFAULT 'untrusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE(organization_id, tool_id)
  );

  What Stays in agent_tools (Profile-Specific)

  -- agent_tools table (profile-tool assignment)
  agent_tools {
    id
    agentId                              // Profile
    toolId                                // Tool

    -- PROFILE-SPECIFIC CREDENTIAL SETTINGS âœ…
    credentialSourceMcpServerId           // Which credential this profile uses
    executionSourceMcpServerId            // Which MCP server pod this profile uses
    useDynamicTeamCredential              // Whether this profile uses dynamic credentials

    created_at
    updated_at
  }

  The Complete Picture

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_config (Tool-Level Configuration)                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Response modifier template (same for all profiles)        â”‚
  â”‚ â€¢ Default allow_usage_when_untrusted_data_is_present        â”‚
  â”‚ â€¢ Default tool_result_treatment                             â”‚
  â”‚                                                              â”‚
  â”‚ ONE row per tool per organization                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ tool_invocation_policies (Tool-Level Security Rules)        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Can this tool be called with these arguments?             â”‚
  â”‚ â€¢ Context-aware conditions (team, credential, profile, etc.)â”‚
  â”‚                                                              â”‚
  â”‚ MULTIPLE rows per tool (one per policy rule)                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ trusted_data_policies (Tool Result Trust Rules)             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Should we trust this tool's output?                       â”‚
  â”‚ â€¢ Context-aware conditions (team, credential, profile, etc.)â”‚
  â”‚                                                              â”‚
  â”‚ MULTIPLE rows per tool (one per policy rule)                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ agent_tools (Profile-Tool Assignment)                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ â€¢ Which credential does THIS PROFILE use for this tool?     â”‚
  â”‚ â€¢ Which MCP server pod does THIS PROFILE use?               â”‚
  â”‚ â€¢ Dynamic vs static credential for THIS PROFILE?            â”‚
  â”‚                                                              â”‚
  â”‚ ONE row per profile-tool combination                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Updated Migration

  -- 0096_refactor_policies_and_tool_config.sql

  -- 1. Create tool_config table for tool-level settings
  CREATE TABLE tool_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,

    response_modifier_template TEXT,
    allow_usage_when_untrusted_data_is_present BOOLEAN NOT NULL DEFAULT false,
    tool_result_treatment TEXT NOT NULL DEFAULT 'untrusted',

    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE(organization_id, tool_id)
  );

  CREATE INDEX idx_tool_config_org_tool ON tool_config(organization_id, tool_id);

  -- 2. Migrate tool-level settings from agent_tools to tool_config
  -- Take first profile's settings as the tool default
  INSERT INTO tool_config (organization_id, tool_id, response_modifier_template, allow_usage_when_untrusted_data_is_present, tool_result_treatment)
  SELECT DISTINCT ON (a.organization_id, at.tool_id)
    a.organization_id,
    at.tool_id,
    at.response_modifier_template,
    at.allow_usage_when_untrusted_data_is_present,
    at.tool_result_treatment
  FROM agent_tools at
  JOIN agents a ON at.agent_id = a.id
  ORDER BY a.organization_id, at.tool_id, at.created_at;

  -- 3. Drop old policy tables
  DROP TABLE IF EXISTS tool_invocation_policies CASCADE;
  DROP TABLE IF EXISTS trusted_data_policies CASCADE;

  -- 4. Create new policy tables
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE tool_invocation_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies(id) ON DELETE CASCADE,
    attribute_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_name, operator, value)
  );

  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE trusted_data_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES trusted_data_policies(id) ON DELETE CASCADE,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_path, operator, value)
  );

  -- Indexes
  CREATE INDEX idx_tool_invocation_policies_tool ON tool_invocation_policies(organization_id, tool_id);
  CREATE INDEX idx_tool_invocation_policy_conditions_policy ON tool_invocation_policy_conditions(policy_id);
  CREATE INDEX idx_trusted_data_policies_tool ON trusted_data_policies(organization_id, tool_id);
  CREATE INDEX idx_trusted_data_policy_conditions_policy ON trusted_data_policy_conditions(policy_id);

  -- 5. Drop tool-level columns from agent_tools (keep only profile-specific ones)
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS allow_usage_when_untrusted_data_is_present;
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS tool_result_treatment;
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS response_modifier_template;
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS policies_auto_configured_at;
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS policies_auto_configuring_started_at;
  ALTER TABLE agent_tools DROP COLUMN IF EXISTS policies_auto_configured_reasoning;

  -- agent_tools now only contains profile-specific credential settings:
  -- - credentialSourceMcpServerId
  -- - executionSourceMcpServerId
  -- - useDynamicTeamCredential

  Updated Schema Files

  New file needed:
  // backend/src/database/schemas/tool-config.ts
  import { boolean, pgTable, text, timestamp, unique, uuid } from "drizzle-orm/pg-core";
  import type { ToolResultTreatment } from "@/types";
  import organizationsTable from "./organization";
  import toolsTable from "./tool";

  const toolConfigTable = pgTable(
    "tool_config",
    {
      id: uuid("id").primaryKey().defaultRandom(),
      organizationId: uuid("organization_id")
        .notNull()
        .references(() => organizationsTable.id, { onDelete: "cascade" }),
      toolId: uuid("tool_id")
        .notNull()
        .references(() => toolsTable.id, { onDelete: "cascade" }),
      responseModifierTemplate: text("response_modifier_template"),
      allowUsageWhenUntrustedDataIsPresent: boolean("allow_usage_when_untrusted_data_is_present")
        .notNull()
        .default(false),
      toolResultTreatment: text("tool_result_treatment")
        .$type<ToolResultTreatment>()
        .notNull()
        .default("untrusted"),
      createdAt: timestamp("created_at", { mode: "date" }).notNull().defaultNow(),
      updatedAt: timestamp("updated_at", { mode: "date" })
        .notNull()
        .defaultNow()
        .$onUpdate(() => new Date()),
    },
    (table) => [unique().on(table.organizationId, table.toolId)],
  );

  export default toolConfigTable;

  UI Changes

  Tools page should show:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tool: search_web                                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                              â”‚
  â”‚ Tool Configuration (applies to all profiles)                â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ â”‚ Response Modifier Template:                          â”‚   â”‚
  â”‚ â”‚ [{{json result}}___________________________________] â”‚   â”‚
  â”‚ â”‚                                                       â”‚   â”‚
  â”‚ â”‚ Default Tool Result Treatment: [Untrusted â–¼]         â”‚   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                              â”‚
  â”‚ Tool Call Policies                                           â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ â”‚ Policy #1                                            â”‚   â”‚
  â”‚ â”‚ If [query] [contains] [hack] â†’ Block always          â”‚   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                              â”‚
  â”‚ Tool Result Policies                                         â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ â”‚ Policy #1                                            â”‚   â”‚
  â”‚ â”‚ If [url] [contains] [company.com] â†’ Mark as trusted  â”‚   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Profile: Sales Assistant                                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Assigned Tools:                                              â”‚
  â”‚                                                              â”‚
  â”‚ â€¢ search_web                                                 â”‚
  â”‚   Credential: [Personal - alice@company.com â–¼]              â”‚
  â”‚   Execution: [Production Search Server â–¼]                   â”‚
  â”‚                                                              â”‚
  â”‚ â€¢ send_email                                                 â”‚
  â”‚   Credential: [Resolve at call time â˜‘]                      â”‚
  â”‚   Execution: [Gmail MCP Server â–¼]                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Summary of Changes

  âœ… Tool-level (same for all profiles):
  - Response modifier template
  - Default tool result treatment
  - Tool invocation policies
  - Trusted data policies

  âœ… Profile-level (specific to each profile):
  - Credential source (which MCP server credential to use)
  - Execution source (which MCP server pod to route to)
  - Dynamic credential toggle

  Is this the correct design now?

> actually let's keep agent-tool table with those fields for serverexcution and credentials for the migration simplicity
we will just display them in the different place. Data schema is fine 

âº Perfect! That's much simpler. Let's keep the agent_tools table completely unchanged and just reorganize the UI.

âº Excellent! This is much simpler. Here's the revised plan:

  Simplified Implementation Plan

  What Changes

  Database:
  - âœ… Drop old policy tables
  - âœ… Create new policy tables with conditions
  - âŒ NO changes to agent_tools table - keep all existing fields

  Backend:
  - Update policy models and evaluation logic
  - Update API routes for policies only

  Frontend:
  - Reorganize UI to show policies at tool level
  - Keep profile-tool assignment UI unchanged (credentials, execution, response modifiers)

  Updated Migration

  -- 0096_refactor_policies.sql

  -- 1. Drop old policy tables ONLY
  DROP TABLE IF EXISTS tool_invocation_policies CASCADE;
  DROP TABLE IF EXISTS trusted_data_policies CASCADE;

  -- 2. Create new policy tables
  CREATE TABLE tool_invocation_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE tool_invocation_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES tool_invocation_policies(id) ON DELETE CASCADE,
    attribute_name TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_name, operator, value)
  );

  CREATE TABLE trusted_data_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    tool_id UUID NOT NULL REFERENCES tools(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    action TEXT NOT NULL DEFAULT 'mark_as_trusted',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE trusted_data_policy_conditions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES trusted_data_policies(id) ON DELETE CASCADE,
    attribute_path TEXT NOT NULL,
    operator TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (policy_id, attribute_path, operator, value)
  );

  -- Indexes
  CREATE INDEX idx_tool_invocation_policies_tool ON tool_invocation_policies(organization_id, tool_id);
  CREATE INDEX idx_tool_invocation_policy_conditions_policy ON tool_invocation_policy_conditions(policy_id);
  CREATE INDEX idx_trusted_data_policies_tool ON trusted_data_policies(organization_id, tool_id);
  CREATE INDEX idx_trusted_data_policy_conditions_policy ON trusted_data_policy_conditions(policy_id);

  -- That's it! agent_tools table unchanged.

  agent_tools Table Stays Exactly As-Is

  // backend/src/database/schemas/agent-tool.ts - NO CHANGES

  const agentToolsTable = pgTable("agent_tools", {
    id: uuid("id").primaryKey().defaultRandom(),
    agentId: uuid("agent_id").notNull().references(() => agentsTable.id, { onDelete: "cascade" }),
    toolId: uuid("tool_id").notNull().references(() => toolsTable.id, { onDelete: "cascade" }),

    // All these fields STAY - just displayed differently in UI
    allowUsageWhenUntrustedDataIsPresent: boolean("allow_usage_when_untrusted_data_is_present")
      .notNull().default(false),
    toolResultTreatment: text("tool_result_treatment")
      .$type<ToolResultTreatment>().notNull().default("untrusted"),
    responseModifierTemplate: text("response_modifier_template"),
    credentialSourceMcpServerId: uuid("credential_source_mcp_server_id")
      .references(() => mcpServerTable.id, { onDelete: "set null" }),
    executionSourceMcpServerId: uuid("execution_source_mcp_server_id")
      .references(() => mcpServerTable.id, { onDelete: "set null" }),
    useDynamicTeamCredential: boolean("use_dynamic_team_credential").notNull().default(false),

    // Can remove these later in a separate cleanup migration
    policiesAutoConfiguredAt: timestamp("policies_auto_configured_at", { mode: "date" }),
    policiesAutoConfiguringStartedAt: timestamp("policies_auto_configuring_started_at", { mode: "date" }),
    policiesAutoConfiguredReasoning: text("policies_auto_configured_reasoning"),

    createdAt: timestamp("created_at", { mode: "date" }).notNull().defaultNow(),
    updatedAt: timestamp("updated_at", { mode: "date" })
      .notNull().defaultNow().$onUpdate(() => new Date()),
  }, (table) => [unique().on(table.agentId, table.toolId)]);

  UI Organization

  Current UI: Everything mixed together in profile-tool view
  Tools Page
    â†’ Profile A + Tool search_web
       â”œâ”€ Credential settings
       â”œâ”€ Response modifier
       â”œâ”€ Tool call policies
       â””â”€ Tool result policies
    â†’ Profile B + Tool search_web (duplicate policies!)
       â”œâ”€ Credential settings
       â”œâ”€ Response modifier
       â”œâ”€ Tool call policies (same as Profile A)
       â””â”€ Tool result policies (same as Profile A)

  New UI: Separate tool-level policies from profile-tool assignment
  Policies Page (NEW)
    â†’ Tool: search_web
       â”œâ”€ Tool call policies (applies to all profiles)
       â””â”€ Tool result policies (applies to all profiles)
    â†’ Tool: send_email
       â”œâ”€ Tool call policies
       â””â”€ Tool result policies

  Tools Page (Updated)
    â†’ Profile A + Tool search_web
       â”œâ”€ Credential settings (stored in agent_tools)
       â”œâ”€ Execution source (stored in agent_tools)
       â”œâ”€ Response modifier (stored in agent_tools)
       â”œâ”€ Allow when untrusted (stored in agent_tools)
       â””â”€ Tool result treatment (stored in agent_tools)
    â†’ Profile B + Tool search_web
       â”œâ”€ Credential settings (stored in agent_tools)
       â”œâ”€ Execution source (stored in agent_tools)
       â”œâ”€ Response modifier (stored in agent_tools)
       â”œâ”€ Allow when untrusted (stored in agent_tools)
       â””â”€ Tool result treatment (stored in agent_tools)

  Data Flow

  Policy Evaluation:
  // Policies come from new tool_invocation_policies table
  const toolPolicies = await db
    .select()
    .from(toolInvocationPoliciesTable)
    .where(eq(toolInvocationPoliciesTable.toolId, toolId));

  // Tool settings come from agent_tools table (profile-specific)
  const agentTool = await db
    .select()
    .from(agentToolsTable)
    .where(and(
      eq(agentToolsTable.agentId, profileId),
      eq(agentToolsTable.toolId, toolId)
    ));

  // Evaluate policies with context
  const policyResult = evaluatePolicies(toolPolicies, {
    profileId,
    teamId,
    credentialScope,
    externalAgentId,
    toolCall,
  });

  // Use agent_tool settings as defaults/overrides
  const finalDecision = {
    ...policyResult,
    allowWhenUntrusted: agentTool.allowUsageWhenUntrustedDataIsPresent,
    resultTreatment: agentTool.toolResultTreatment,
  };

  Simplified File Changes

  Database: 5 files
  1. Migration: 0096_refactor_policies.sql
  2. Schema: tool-invocation-policy.ts (update)
  3. Schema: trusted-data-policy.ts (update)
  4. Schema: tool-invocation-policy-condition.ts (new)
  5. Schema: trusted-data-policy-condition.ts (new)

  Backend: ~15 files
  - Models: Update policy models (2 files)
  - Routes: Update policy routes (4 files)
  - Types: Update policy types (3 files)
  - Utils: Add context helpers (2 files)
  - Archestra tools: Update policy tools (1 file)
  - Tests: Update tests (3 files)

  Frontend: ~10 files
  - New page: /policies for tool-level policy management
  - Update: /tools page to show profile-tool assignments only
  - Components: Policy UI with inline conditions (5 files)
  - Queries: Update hooks (2 files)
  - Utils: Add context attribute helpers (1 file)

  Total: ~30 files (down from ~35)

  Reduced Complexity

  âœ… No data migration for agent_tools
  âœ… No schema changes for agent_tools
  âœ… All existing credential/execution logic unchanged
  âœ… Simpler migration script
  âœ… Lower risk

  Should I proceed with this simplified plan?



