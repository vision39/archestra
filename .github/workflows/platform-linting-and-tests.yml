name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean
      is-release-please-pr:
        description: "Whether this is a release-please PR (enables auto-commit of codegen changes)"
        required: false
        type: boolean
        default: false
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN:
        required: true
      TURBOREPO_REMOTE_CACHING_TEAM:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      # Required for release-please PRs to push codegen changes with a token that triggers workflow re-runs
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      # see https://stackoverflow.com/a/67551255
      ARCHESTRA_RELEASER_GITHUB_APP_ID:
        required: false
      ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY:
        required: false

jobs:
  paths-filter:
    name: Detect changed paths
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      mcp-server-base-image: ${{ steps.filter.outputs.mcp-server-base-image }}
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Filter paths
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            mcp-server-base-image:
              - 'platform/mcp_server_docker_image/**'
              - '.github/workflows/build-base-mcp-server-docker-image.yml'

  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform
    env:
      TURBO_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

  platform-e2e-tests:
    name: Platform e2e Tests
    runs-on: blacksmith-16vcpu-ubuntu-2404
    permissions:
      contents: write
    steps:
      # Generate a GitHub App token for release-please PRs
      # This is needed because pushes made with GITHUB_TOKEN do not trigger workflow re-runs,
      # but pushes made with a GitHub App token DO trigger workflows.
      # This allows the codegen commit to properly re-trigger CI checks.
      #
      # see https://stackoverflow.com/a/67551255
      - name: Generate token for release-please PR
        if: ${{ inputs.should-skip-running-and-always-succeed != true && inputs.is-release-please-pr == true }}
        id: generate-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_ID }}
          private-key: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Persist credentials for release-please PRs to allow auto-committing codegen changes
          persist-credentials: ${{ inputs.is-release-please-pr }} # zizmor: ignore[artipacked] -- persist-credentials is conditionally true only for release-please PRs
          # For release-please PRs, checkout the actual PR branch (not the merge commit)
          # to avoid detached HEAD state which would cause git push to fail
          ref: ${{ inputs.is-release-please-pr && github.head_ref || '' }}
          # Use the GitHub App token for release-please PRs so that the codegen commit push
          # triggers a new workflow run (pushes with GITHUB_TOKEN don't trigger workflows)
          # see https://stackoverflow.com/a/67551255
          token: ${{ steps.generate-token.outputs.token || github.token }}

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Setup Archestra Platform
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-archestra-platform
        with:
          kind-config-path: .github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: .github/values-ci.yaml
          deploy-e2e-dependencies: "true"
          build-platform-image: "true"
          platform-image-tag: archestra/platform:ci-test
          platform-context: ./platform
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      # Check migration consistency using drizzle-kit check
      # https://orm.drizzle.team/docs/drizzle-kit-check
      # The drizzle-kit check command lets you check consistency of your generated SQL migrations history
      - name: Check drizzle-kit migrations consistency
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform/backend
        run: pnpm drizzle-kit check

      - name: Check for codegen'd changes
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform
        env:
          IS_RELEASE_PLEASE_PR: ${{ inputs.is-release-please-pr }}
        run: |
          pnpm codegen
          # Ensure generated files are properly formatted and linted
          pnpm lint:fix

          # Check both unstaged and staged changes
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            # For release-please PRs, auto-commit the codegen changes
            # This is needed because release-please bumps the version in package.json,
            # which causes generated files (like docs/openapi.json) to be out of date
            if [ "$IS_RELEASE_PLEASE_PR" == "true" ]; then
              echo "ðŸ“¦ Release-please PR with codegen changes detected. Auto-committing..."

              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              # Only add changes under docs/ and platform/ - these are the directories
              # that may have codegen changes (e.g., docs/openapi.json version bump,
              # docs/pages/platform-access-control.md front matter timestamp)
              git -C "$GITHUB_WORKSPACE" add docs/ platform/

              git commit -m "chore: update docs/openapi.json version for release"
              git push

              echo "âœ… Changes committed. Workflow will be re-triggered."

              # Exit early - the push triggers a new workflow run with the updated code
              exit 0
            else
              echo "::error::Generated code is not up to date. Please run 'pnpm codegen && pnpm lint:fix' locally and commit the changes."
              exit 1
            fi
          else
            echo "Generated code is up to date"
            echo "codegen-changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify no pending database migrations
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        id: db-migration-check
        working-directory: ./platform
        run: |
          # Run db generate with timeout to prevent hanging on interactive prompts
          set +e  # Don't exit on command failure

          echo "Running pnpm db:generate -- awaiting up to 15 seconds for a potential drizzle-kit generate interactive prompt (which could indicate a pending database migration, such as a table rename)"

          # Use timeout and expect no interaction - if it hangs, it means there's a pending migration which requires
          # user input to continue
          if timeout 15s pnpm db:generate > /tmp/db_generate_output.txt 2>&1; then
            # Command completed successfully within timeout
            output=$(cat /tmp/db_generate_output.txt)
            echo "Output from pnpm db:generate:"
            echo "$output"

            # Check if there's an interactive prompt in the output (shouldn't happen if it completed)
            if echo "$output" | grep -q "â¯\|Is.*table created or renamed"; then
              echo "âŒ Interactive prompt detected - there are pending database migrations that need to be committed"
              echo "Run 'pnpm db:generate' locally, make your choices, and commit the resulting migration files"
              exit 1
            fi
          else
            # Command timed out or failed
            exit_code=$?
            output=$(cat /tmp/db_generate_output.txt 2>/dev/null || echo "No output captured")

            echo "Output from pnpm db:generate (before timeout/failure):"
            echo "$output"

            if [ $exit_code -eq 124 ]; then
              # Timeout occurred - likely waiting for interactive input
              echo "âŒ Command timed out - likely waiting for interactive input about pending database migrations"
              echo "Run 'pnpm db:generate' locally, make your choices, and commit the resulting migration files"
            else
              echo "âŒ pnpm db:generate failed with exit code $exit_code"
            fi
            exit 1
          fi

          set -e  # Re-enable exit on error

          # Check both unstaged and staged changes
          # If db:generate produced new migration files, it means the PR is missing migrations
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            echo "::error::Database schema has changed but migrations are missing. Please run 'pnpm db:generate' locally and commit the resulting migration files."
            git diff --name-only
            git diff --cached --name-only
            exit 1
          else
            echo "âœ… No new migration files were generated - schema is in sync with migrations"
          fi

      # Resolve Playwright version for the container used to run e2e tests
      - name: Resolve Playwright version
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          VERSION=$(cat platform/e2e-tests/package.json | jq -r '.devDependencies["@playwright/test"]' | sed 's/^[\^~]//')
          echo "Resolved Playwright version: $VERSION"
          echo "PLAYWRIGHT_VERSION=$VERSION" >> $GITHUB_ENV

      # Run E2E tests inside the official Playwright container
      # This eliminates the need for manual Playwright browser installation and caching
      # See https://github.com/microsoft/playwright/issues/7249#issuecomment-3345742301
      - name: Run E2E tests
        id: e2e
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform
        run: |
          set -o pipefail
          docker run --rm \
            --network host \
            --ipc=host \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work/platform \
            -e CI=true \
            -e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
            "mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION}-noble" \
            /bin/bash -c "corepack enable && corepack prepare pnpm@10.24.0 --activate && pnpm test:e2e" \
            2>&1 | tee playwright-output.txt

      - name: Check for flaky tests
        id: check-flaky
        if: success()
        run: |
          # Playwright outputs "X flaky" in its summary when tests pass on retry
          if grep -qE "[0-9]+ flaky" platform/playwright-output.txt 2>/dev/null; then
            echo "âš ï¸ Flaky tests detected"
            echo "has_flaky_tests=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload Playwright report
        if: failure() || steps.check-flaky.outputs.has_flaky_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          retention-days: 30

      - name: Show logs on failure or flaky tests
        if: failure() || steps.check-flaky.outputs.has_flaky_tests == 'true'
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200

          echo "=== WireMock Logs ==="
          kubectl logs -l app=e2e-tests-wiremock --tail=200

          echo "=== Keycloak Logs ==="
          kubectl logs -l app.kubernetes.io/name=keycloak --tail=200

          echo "=== Describe Archestra Platform Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=archestra-platform

          echo "=== Describe PostgreSQL Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=postgresql

  platform-docker-image-scanning:
    name: Platform Docker Image Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        if: ${{ github.event_name == 'pull_request' && inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true

      - name: Build Docker image
        if: ${{ github.event_name == 'pull_request' && inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          load: "true"
          tags: archestra/platform:ci-test
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      # Run docker scout to check for vulnerabilities and recommendations
      # https://github.com/docker/scout-action
      #
      # Branch ruleset has been configured to block PRs with critical or high vulnerabilities.
      # https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-code-scanning-alerts#pull-request-check-failures-for-code-scanning-alerts
      #
      # NOTE: This step is skipped for PRs from forks because GitHub doesn't expose
      # repository secrets to workflows triggered by fork PRs (for security reasons).
      # Docker Scout requires Docker Hub authentication to run.
      - name: Docker Scout
        if: ${{ github.event_name == 'pull_request' && inputs.should-skip-running-and-always-succeed != true && github.event.pull_request.head.repo.fork != true }}
        uses: docker/scout-action@f8c776824083494ab0d56b8105ba2ca85c86e4de # v1.18.2
        with:
          command: cves,recommendations,compare
          image: archestra/platform:ci-test
          to: docker.io/archestra/platform:latest
          dockerhub-user: ${{ secrets.DOCKER_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_PASSWORD }}
          ignore-unchanged: true
          only-severities: critical,high
          write-comment: false
          sarif-file: sarif.output.json

      # Upload SARIF result to GitHub Code Scanning
      # https://github.com/docker/scout-action?tab=readme-ov-file#analyze-vulnerabilities-and-upload-report-to-github-code-scanning
      #
      # NOTE: Skipped for fork PRs since Docker Scout step is skipped (no SARIF file generated).
      - name: Upload SARIF result
        if: ${{ github.event_name == 'pull_request' && inputs.should-skip-running-and-always-succeed != true && github.event.pull_request.head.repo.fork != true }}
        uses: github/codeql-action/upload-sarif@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        with:
          sarif_file: sarif.output.json

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform/helm/archestra
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.3
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1

  # Test that the MCP server base Docker image builds successfully
  # Only runs when relevant files are changed
  mcp-server-base-image-build:
    name: MCP Server Base Image Build
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.mcp-server-base-image == 'true' }}
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    uses: ./.github/workflows/build-base-mcp-server-docker-image.yml
    with:
      push_to_gcr: false
      version: test
