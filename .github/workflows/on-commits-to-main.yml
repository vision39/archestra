name: On commits to main

on:
  push:
    branches:
      - main
  # Allow manual triggering of the workflow
  workflow_dispatch:

# Set default permissions to empty to enforce least privilege
# Each job will explicitly declare the permissions it needs
permissions: {}

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required for actions/checkout
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            docs:
              - 'docs/**'

  build-dev-image:
    name: Build Platform Dev Docker Image
    runs-on: blacksmith-16vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Artifact Registry
        uses: ./.github/actions/auth-to-gar
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      # NOTE: only build on amd64 for now as our staging environment runs on amd64
      # if we will need to support arm64, we should follow the pattern we do in
      # .github/workflows/build-dockerhub-image.yml and do a matrix build so that we are build
      # on both amd64 and arm64 using native arch (to massively speed up the builds)
      - name: Build Docker image
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          push: "true"
          platforms: linux/amd64
          version: ${{ github.sha }}
          tags: europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
          sentry-auth-token: ${{ secrets.PLATFORM_NEXTJS_SOURCE_MAP_SENTRY_AUTH_TOKEN }}

  deploy-to-staging:
    name: Deploy to staging
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: build-dev-image
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2.1.7
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials archestra-staging \
            --zone us-central1-a \
            --project friendly-path-465518-r6

      # NOTE: temporarily removing the following to debug something..
      # --set archestra.env.ARCHESTRA_AUTH_COOKIE_DOMAIN="${{ secrets.ARCHESTRA_STAGING_AUTH_COOKIE_DOMAIN }}" \
      - name: Deploy to staging
        run: |
          helm upgrade archestra-platform \
            ./platform/helm/archestra \
            --install \
            --namespace archestra \
            --create-namespace \
            --set archestra.image=europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }} \
            --set archestra.databaseUrl="${{ secrets.ARCHESTRA_STAGING_DATABASE_URL }}" \
            --set archestra.env.ARCHESTRA_API_BASE_URL="https://backend.archestra.dev" \
            --set archestra.env.ARCHESTRA_METRICS_SECRET="${{ secrets.ARCHESTRA_STAGING_METRICS_SECRET }}" \
            --set archestra.env.ARCHESTRA_OTEL_EXPORTER_OTLP_ENDPOINT="${{ secrets.ARCHESTRA_STAGING_OTEL_EXPORTER_OTLP_ENDPOINT }}" \
            --set archestra.env.ARCHESTRA_AUTH_SECRET="${{ secrets.ARCHESTRA_STAGING_AUTH_SECRET }}" \
            --set archestra.env.ARCHESTRA_AUTH_ADMIN_EMAIL="${{ secrets.ARCHESTRA_STAGING_AUTH_ADMIN_EMAIL }}" \
            --set archestra.env.ARCHESTRA_AUTH_ADMIN_PASSWORD="${{ secrets.ARCHESTRA_STAGING_AUTH_ADMIN_PASSWORD }}" \
            --set archestra.env.ARCHESTRA_SENTRY_ENVIRONMENT="archestra.dev" \
            --set archestra.env.ARCHESTRA_SENTRY_BACKEND_DSN="${{ secrets.ARCHESTRA_STAGING_SENTRY_BACKEND_DSN }}" \
            --set archestra.env.ARCHESTRA_SENTRY_FRONTEND_DSN="${{ secrets.ARCHESTRA_STAGING_SENTRY_FRONTEND_DSN }}" \
            --values .github/values-staging.yaml \
            --wait

  trigger-website-deploy:
    name: Trigger Website Vercel Deploy
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.docs == 'true'
    permissions:
      contents: read
    steps:
      - name: Trigger Vercel Deploy Hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.WEBSITE_VERCEL_DEPLOY_HOOK_URL }}
        run: |
          curl -X POST "$VERCEL_DEPLOY_HOOK_URL"
