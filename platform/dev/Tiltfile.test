# Test resources

local_resource(
  'unit-tests',
  cmd='pnpm test',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

local_resource(
  'helm-tests',
  cmd='helm unittest helm/archestra',
  dir='../',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False
)

local_resource(
  'e2e-tests',
  cmd='pnpm test:e2e',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

local_resource(
  'e2e-tests-ui',
  serve_cmd='pnpm test:e2e:ui',
  serve_dir='../',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

# E2E test dependencies (WireMock, Keycloak)
# Deploys the e2e-tests helm chart which includes:
#   - WireMock for API mocking
#   - Keycloak for SSO testing with pre-configured test users
#
# Test users are defined in helm/e2e-tests/values.yaml:
#   - admin@example.com (archestra-admins group) - matches default Archestra admin
#   - member@example.com (archestra-users group) - for role mapping tests
#
# The defaults align with Archestra's default admin credentials, so no overrides needed.
load('ext://helm_resource', 'helm_resource')

local_resource(
  'e2e-test-dependencies',
  cmd=' && '.join([
    'helm upgrade --install e2e-tests ../helm/e2e-tests --namespace default --wait',
    'echo ""',
    'echo "========================================"',
    'echo "  E2E Test Dependencies Ready"',
    'echo "========================================"',
    'echo ""',
    'echo "  Keycloak Admin Console:"',
    'echo "    URL:   http://localhost:30081"',
    'echo "    Login: admin / admin"',
    'echo ""',
    'echo "  Pre-created test users (realm: archestra):"',
    'echo "    admin@example.com  / password    (group: archestra-admins)"',
    'echo "    member@example.com / memberpass  (group: archestra-users)"',
    'echo ""',
    'echo "  WireMock: http://localhost:9092"',
    'echo ""',
    'echo "  ----------------------------------------"',
    'echo "  Configure Generic OIDC in Archestra:"',
    'echo "  ----------------------------------------"',
    'echo "    Provider ID:             keycloak"',
    'echo "    Issuer:                  http://localhost:30081/realms/archestra"',
    'echo "    Domain:                  example.com"',
    'echo "    Client ID:               archestra-oidc"',
    'echo "    Client Secret:           archestra-oidc-secret"',
    'echo "    Discovery Endpoint:      http://localhost:30081/realms/archestra/.well-known/openid-configuration"',
    'echo "    Authorization Endpoint:  http://localhost:30081/realms/archestra/protocol/openid-connect/auth"',
    'echo "    Token Endpoint:          http://localhost:30081/realms/archestra/protocol/openid-connect/token"',
    'echo "    JWKS Endpoint:           http://localhost:30081/realms/archestra/protocol/openid-connect/certs"',
    'echo "    PKCE:                    Enabled"',
    'echo ""',
    'echo "  Note: If token exchange fails, replace localhost:30081 with"',
    'echo "    e2e-tests-keycloak.default.svc.cluster.local:8080 for"',
    'echo "    Token/JWKS/Discovery endpoints (fetched server-side)."',
    'echo "========================================"',
  ]),
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  serve_cmd='kubectl port-forward svc/e2e-tests-wiremock 9092:8080 & kubectl port-forward svc/e2e-tests-keycloak 30081:8080 & wait',
)
